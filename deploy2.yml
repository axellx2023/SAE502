---
# deploy2.yml â€“ Tout-en-un : test de connexion + dÃ©ploiement complet
#
# 1. Configurer une seule fois inventory.ini :
#    [vpn_servers]
#    192.168.101.137
#
#    [vpn_servers:vars]
#    ansible_user=ubuntu
#    ansible_ssh_common_args='-o StrictHostKeyChecking=no'
#    ansible_python_interpreter=/usr/bin/python3
#
# 2. Lancer : ansible-playbook deploy2.yml
#    (ou ansible-playbook deploy2.yml --ask-become-pass si sudo demande un mot de passe)
#
# Ce playbook : teste la connexion (ping), puis dÃ©ploie systÃ¨me, firewall, WireGuard,
# Docker (stack complÃ¨te), Nginx, et met Ã  jour lâ€™Endpoint de tous les clients (4G).

- name: "Ã‰tape 1 â€“ Tester la connexion (ping)"
  hosts: vpn_servers
  gather_facts: false
  tasks:
    - name: VÃ©rifier que les hÃ´tes sont joignables
      ansible.builtin.ping:
      register: ping_result
      failed_when: false

    - name: Ã‰chouer si le serveur ne rÃ©pond pas
      ansible.builtin.fail:
        msg: |
          Impossible de joindre le serveur {{ inventory_hostname }}.
          VÃ©rifiez inventory.ini (IP ou hostname) et la connexion SSH.
      when: ping_result.ping | default('') != 'pong'

    - name: Connexion OK
      ansible.builtin.debug:
        msg: "Connexion OK vers {{ inventory_hostname }} (pong)"

- name: "Ã‰tape 2 â€“ DÃ©ploiement complet (systÃ¨me, firewall, WireGuard, Docker, Nginx)"
  hosts: vpn_servers
  become: true
  gather_facts: true
  vars:
    deployment_stage: "full"

  pre_tasks:
    - name: VÃ©rifier que le systÃ¨me est Ubuntu
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Ubuntu"
        fail_msg: "Ce playbook est conÃ§u pour Ubuntu uniquement"
        success_msg: "SystÃ¨me Ubuntu dÃ©tectÃ©"

    - name: Mettre Ã  jour le cache des paquets
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

  roles:
    - role: system
      tags: system
    - role: firewall
      tags: firewall
    - role: wireguard
      tags: wireguard
    - role: docker
      tags: docker
    - role: nginx
      tags: nginx

  post_tasks:
    - name: Afficher un rÃ©sumÃ© du dÃ©ploiement
      ansible.builtin.debug:
        msg:
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS !"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ” WireGuard VPN"
          - "   â€¢ Interface : {{ wireguard_interface }}"
          - "   â€¢ Port : {{ wireguard_port }}/udp"
          - "   â€¢ RÃ©seau VPN : {{ wireguard_network }}"
          - "   â€¢ IP serveur VPN : {{ wireguard_server_ip }}"
          - "   â€¢ Endpoint (4G/externe) : {{ wireguard_effective_endpoint_ip }}:{{ wireguard_port }} (dÃ©tection auto)"
          - ""
          - "ğŸŒ Services accessibles depuis l'extÃ©rieur (LAN) :"
          - "   â€¢ WebUI      : http://{{ ansible_default_ipv4.address }}:80"
          - ""
          - "ğŸ”’ Services internes (via VPN) :"
          - "   â€¢ Service web : http://{{ wireguard_server_ip }}:8080"
          - "   â€¢ Grafana : http://{{ wireguard_server_ip }}:{{ grafana_port }}"
          - "   â€¢ Prometheus : http://{{ wireguard_server_ip }}:{{ prometheus_port }} (admin)"
          - ""
          - "ğŸ“± Prochaines Ã©tapes : ansible-playbook add_user.yml (crÃ©er un client VPN)"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
