---
# Playbook principal de dÃ©ploiement complet
# Installe et configure un serveur VPN WireGuard avec supervision
- name: DÃ©ploiement complet du serveur VPN WireGuard
  hosts: vpn_servers
  become: yes
  gather_facts: yes

  vars:
    # Variables de dÃ©ploiement
    deployment_stage: "full"

  pre_tasks:
    - name: VÃ©rifier que le systÃ¨me est Ubuntu
      assert:
        that:
          - ansible_distribution == "Ubuntu"
        fail_msg: "Ce playbook est conÃ§u pour Ubuntu uniquement"
        success_msg: "SystÃ¨me Ubuntu dÃ©tectÃ©"

    - name: Mettre Ã  jour le cache des paquets
      apt:
        update_cache: yes
        cache_valid_time: 3600

  roles:
    - role: system
      tags: system
    - role: firewall
      tags: firewall
    - role: wireguard
      tags: wireguard
    - role: docker
      tags: docker
    - role: nginx
      tags: nginx

  post_tasks:
    - name: S'assurer que les rÃ¨gles iptables sont appliquÃ©es
      ansible.builtin.include_tasks: roles/wireguard/tasks/ensure_iptables.yml
      tags:
        - wireguard
        - iptables
    - name: RÃ©cupÃ©rer l'IP publique 4G si disponible
      shell: curl -s ifconfig.me
      register: public_ip_4g
      changed_when: false
      failed_when: false

    - name: Afficher un rÃ©sumÃ© du dÃ©ploiement
      debug:
        msg:
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS !"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ” WireGuard VPN"
          - "   â€¢ Interface : {{ wireguard_interface }}"
          - "   â€¢ Port : {{ wireguard_port }}/udp"
          - "   â€¢ RÃ©seau VPN : {{ wireguard_network }}"
          - "   â€¢ IP serveur VPN : {{ wireguard_server_ip }}"
          - ""
          - "ğŸŒ Services accessibles depuis l'extÃ©rieur (LAN) :"
          - "   â€¢ WebUI      : http://{{ ansible_default_ipv4.address }}:{{ webui_port }}"
          - "     (Gestion des configurations VPN - authentification Basic Auth: admin/admin)"
          - "     Note: Le WebUI Flask est accessible directement sur le port {{ webui_port }}"
          - ""
          - "ğŸ”’ Services internes (accessibles via VPN selon le rÃ´le) :"
          - "   â€¢ Service web interne : http://{{ wireguard_server_ip }}:{{ nginx_port }}"
          - "   â€¢ Grafana : http://{{ wireguard_server_ip }}:{{ grafana_port }}"
          - "   â€¢ Prometheus : http://{{ wireguard_server_ip }}:{{ prometheus_port }} (admin uniquement)"
          - ""
          - "ğŸ‘¥ Gestion des rÃ´les utilisateurs :"
          - "   â€¢ restricted : AccÃ¨s VPN uniquement (aucun service)"
          - "   â€¢ allowed : VPN + services internes (Nginx, Grafana)"
          - "   â€¢ admin : AccÃ¨s complet (tous les services incluant Prometheus)"
          - ""
          - "ğŸ“Š Services de supervision (localhost uniquement) :"
          - "   â€¢ Prometheus : http://localhost:{{ prometheus_port }}"
          - "     â†’ Targets : http://localhost:{{ prometheus_port }}/targets"
          - "   â€¢ Grafana    : http://localhost:{{ grafana_port }}"
          - "     â†’ Login: {{ grafana_admin_user }} / {{ grafana_admin_password }}"
          - "     â†’ Dashboard WireGuard : Auto-provisionnÃ© et disponible automatiquement"
          - "   â€¢ WireGuard Exporter : http://localhost:9586/metrics"
          - ""
          - "ğŸ“± Prochaines Ã©tapes :"
          - "   1. Trouvez votre IP publique 4G : curl ifconfig.me (depuis la VM)"
          - "   2. Ajoutez-la dans group_vars/vpn_servers.yml : wireguard_server_public_ip"
          - "   3. CrÃ©ez un client : ansible-playbook add_user.yml"
          - "      â†’ RÃ´les disponibles : restricted, allowed, admin"
          - "      â†’ Le playbook trouvera automatiquement l'IP disponible"
          - ""
          - "ğŸ’¡ IP publique dÃ©tectÃ©e : {{ public_ip_4g.stdout | default('Non dÃ©tectÃ©e automatiquement') }}"
          - "   (VÃ©rifiez et ajoutez-la dans group_vars/vpn_servers.yml si nÃ©cessaire)"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
