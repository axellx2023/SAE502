---
- name: "Installer UFW"
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: yes

- name: "Réinitialiser UFW (mode par défaut: deny)"
  ansible.builtin.command: ufw --force reset
  changed_when: true

- name: "Définir la politique par défaut: deny incoming"
  ansible.builtin.command: ufw default deny incoming
  changed_when: true

- name: "Définir la politique par défaut: allow outgoing"
  ansible.builtin.command: ufw default allow outgoing
  changed_when: true

- name: "Autoriser WireGuard (51820/udp)"
  ansible.builtin.command: ufw allow 51820/udp
  changed_when: true

- name: "Autoriser SSH (optionnel)"
  ansible.builtin.command: ufw allow 22/tcp
  when: firewall_allow_ssh | default(true)
  changed_when: true

- name: "Autoriser WebUI (port 5000/tcp) depuis le LAN pour télécharger les configs"
  ansible.builtin.command: ufw allow {{ webui_port }}/tcp
  changed_when: true
  tags:
    - firewall
    - webui

- name: "Note: WebUI accessible depuis le LAN pour télécharger les configs VPN"
  ansible.builtin.debug:
    msg: "WebUI accessible sur http://{{ ansible_default_ipv4.address }}:{{ webui_port }} depuis le LAN (pour télécharger les configs avant connexion VPN)"
  tags:
    - firewall
    - webui

- name: "Autoriser Prometheus depuis localhost uniquement"
  ansible.builtin.command: ufw allow from 127.0.0.1 to any port 9090 proto tcp
  changed_when: true

- name: "Autoriser Grafana depuis localhost"
  ansible.builtin.command: ufw allow from 127.0.0.1 to any port 3000 proto tcp
  changed_when: true

- name: "Autoriser l'accès aux services internes depuis le réseau VPN (10.8.0.0/24)"
  ansible.builtin.command: ufw allow from {{ wireguard_network }} to any port {{ item }} proto tcp
  loop:
    - "{{ nginx_port }}"  # Nginx interne (8080)
    - "{{ grafana_port }}"  # Grafana (3000)
  changed_when: true
  tags:
    - firewall
    - vpn

- name: "Autoriser Prometheus depuis le réseau VPN (pour rôle admin uniquement, géré individuellement)"
  ansible.builtin.debug:
    msg: "Prometheus ({{ prometheus_port }}) sera accessible uniquement pour les clients avec rôle 'admin' (règles ajoutées individuellement)"
  changed_when: false
  tags:
    - firewall
    - vpn

- name: "Note: Les règles individuelles par IP pour les rôles sont ajoutées lors de l'ajout de clients"
  ansible.builtin.debug:
    msg: "Les règles UFW pour les utilisateurs VPN sont créées automatiquement lors de l'ajout de clients selon leur rôle (restricted/allowed/admin)"
  changed_when: false

- name: "Configurer UFW pour autoriser le trafic depuis l'interface WireGuard"
  ansible.builtin.command: ufw allow in on {{ wireguard_interface }} to any
  changed_when: true
  failed_when: false
  tags:
    - firewall
    - vpn

- name: "Activer UFW"
  ansible.builtin.command: ufw --force enable
  changed_when: true
