---
- name: "Installer UFW"
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: yes

- name: "Réinitialiser UFW (mode par défaut: deny)"
  ansible.builtin.command: ufw --force reset
  changed_when: true

- name: "Définir la politique par défaut: deny incoming"
  ansible.builtin.command: ufw default deny incoming
  changed_when: true

- name: "Définir la politique par défaut: allow outgoing"
  ansible.builtin.command: ufw default allow outgoing
  changed_when: true

- name: "Autoriser WireGuard (51820/udp)"
  ansible.builtin.command: ufw allow 51820/udp
  changed_when: true

- name: "Autoriser SSH (optionnel)"
  ansible.builtin.command: ufw allow 22/tcp
  when: firewall_allow_ssh | default(true)
  changed_when: true

- name: "Autoriser WebUI (port 5000/tcp) depuis l'extérieur"
  ansible.builtin.command: ufw allow 5000/tcp
  changed_when: true

- name: "Autoriser HTTP interne depuis le réseau VPN"
  ansible.builtin.command: ufw allow from 10.10.10.0/24 to any port 80
  changed_when: true

- name: "Autoriser HTTPS interne depuis le réseau VPN"
  ansible.builtin.command: ufw allow from 10.10.10.0/24 to any port 443
  changed_when: true

- name: "Autoriser Prometheus depuis localhost"
  ansible.builtin.command: ufw allow from 127.0.0.1 to any port 9090
  changed_when: true

- name: "Autoriser Grafana depuis localhost"
  ansible.builtin.command: ufw allow from 127.0.0.1 to any port 3000
  changed_when: true

- name: "Autoriser Grafana depuis le réseau VPN"
  ansible.builtin.command: ufw allow from 10.10.10.0/24 to any port 3000
  changed_when: true

- name: "Activer UFW"
  ansible.builtin.command: ufw --force enable
  changed_when: true
