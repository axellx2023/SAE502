---
- name: "Installer UFW"
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: yes

- name: "Réinitialiser UFW (mode par défaut: deny)"
  ansible.builtin.command: ufw --force reset
  changed_when: true

- name: "Définir la politique par défaut: deny incoming"
  ansible.builtin.command: ufw default deny incoming
  changed_when: true

- name: "Définir la politique par défaut: allow outgoing"
  ansible.builtin.command: ufw default allow outgoing
  changed_when: true

- name: "Autoriser WireGuard (51820/udp)"
  ansible.builtin.command: ufw allow 51820/udp
  changed_when: true

- name: "Autoriser SSH (optionnel)"
  ansible.builtin.command: ufw allow 22/tcp
  when: firewall_allow_ssh | default(true)
  changed_when: true

- name: "Autoriser Nginx reverse-proxy WebUI (port 80/tcp) depuis l'extérieur"
  ansible.builtin.command: ufw allow 80/tcp
  changed_when: true
  tags:
    - firewall
    - webui

- name: "Note: Le WebUI Flask reste accessible sur le port 5000 en localhost uniquement (protégé par Nginx sur port 80)"
  ansible.builtin.debug:
    msg: "Le port 5000 n'est plus directement accessible depuis l'extérieur. Utilisez http://{{ ansible_default_ipv4.address }}:80 avec authentification Basic Auth (admin/admin)"
  tags:
    - firewall
    - webui

- name: "Autoriser Prometheus depuis localhost uniquement"
  ansible.builtin.command: ufw allow from 127.0.0.1 to any port 9090 proto tcp
  changed_when: true

- name: "Autoriser Grafana depuis localhost"
  ansible.builtin.command: ufw allow from 127.0.0.1 to any port 3000 proto tcp
  changed_when: true

- name: "Note: Les règles HTTP/HTTPS/Grafana depuis le VPN sont gérées individuellement selon les rôles"
  ansible.builtin.debug:
    msg: "Les règles UFW pour les utilisateurs VPN sont créées automatiquement lors de l'ajout de clients selon leur rôle (restricted/allowed/admin)"
  changed_when: false

- name: "Activer UFW"
  ansible.builtin.command: ufw --force enable
  changed_when: true
