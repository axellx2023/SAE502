---
- name: "Installer UFW"
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: yes

- name: "Réinitialiser UFW (mode par défaut: deny)"
  ansible.builtin.command: ufw --force reset
  changed_when: true

- name: "Définir la politique par défaut: deny incoming"
  ansible.builtin.command: ufw default deny incoming
  changed_when: true

- name: "Définir la politique par défaut: allow outgoing"
  ansible.builtin.command: ufw default allow outgoing
  changed_when: true

- name: "Autoriser WireGuard (51820/udp)"
  ansible.builtin.command: ufw allow 51820/udp
  changed_when: true

- name: "Autoriser SSH (optionnel)"
  ansible.builtin.command: ufw allow 22/tcp
  when: firewall_allow_ssh | default(true)
  changed_when: true

- name: "Autoriser WebUI (port 5000/tcp) depuis le LAN pour télécharger les configs"
  ansible.builtin.command: ufw allow {{ webui_port }}/tcp
  changed_when: true
  tags:
    - firewall
    - webui

- name: "Autoriser WebUI via Nginx (port 80/tcp) depuis le LAN avec Basic Auth"
  ansible.builtin.command: ufw allow 80/tcp
  changed_when: true
  tags:
    - firewall
    - webui
    - nginx

- name: "Note: WebUI accessible depuis le LAN pour télécharger les configs VPN"
  ansible.builtin.debug:
    msg: |
      WebUI accessible depuis le LAN :
      - Direct : http://{{ ansible_default_ipv4.address }}:{{ webui_port }} (sans authentification)
      - Via Nginx : http://{{ ansible_default_ipv4.address }}:80 (avec Basic Auth: admin/admin)
  tags:
    - firewall
    - webui

- name: "Autoriser Prometheus depuis localhost uniquement"
  ansible.builtin.command: ufw allow from 127.0.0.1 to any port 9090 proto tcp
  changed_when: true

- name: "Autoriser Grafana depuis localhost"
  ansible.builtin.command: ufw allow from 127.0.0.1 to any port 3000 proto tcp
  changed_when: true

- name: "Note: Les règles d'accès aux services internes sont gérées individuellement par IP selon le rôle"
  ansible.builtin.debug:
    msg: |
      Les règles UFW pour les services internes sont ajoutées individuellement lors de l'ajout de clients :
      - restricted : Aucune règle (VPN uniquement, aucun service)
      - allowed : Accès à Nginx ({{ nginx_port }}) et Grafana ({{ grafana_port }})
      - admin : Accès complet ({{ nginx_port }}, {{ grafana_port }}, {{ prometheus_port }})
      
      Les règles générales pour tout le réseau VPN ne sont PAS ajoutées pour respecter les restrictions par rôle.
  changed_when: false
  tags:
    - firewall
    - vpn

- name: "Note: Les règles individuelles par IP pour les rôles sont ajoutées lors de l'ajout de clients"
  ansible.builtin.debug:
    msg: "Les règles UFW pour les utilisateurs VPN sont créées automatiquement lors de l'ajout de clients selon leur rôle (restricted/allowed/admin)"
  changed_when: false

- name: "Configurer UFW pour autoriser le trafic depuis l'interface WireGuard"
  ansible.builtin.command: ufw allow in on {{ wireguard_interface }} to any
  changed_when: true
  failed_when: false
  tags:
    - firewall
    - vpn

- name: "Activer UFW"
  ansible.builtin.command: ufw --force enable
  changed_when: true
