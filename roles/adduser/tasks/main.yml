---
# Rôle AddUser - Ajout d'un client VPN avec génération de clés, QR code et gestion des rôles
- name: Vérifier que le répertoire des clients existe
  file:
    path: "{{ wireguard_clients_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - adduser
    - config

- name: Vérifier que le répertoire QR existe
  file:
    path: "{{ wireguard_qr_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - adduser
    - config

- name: Définir le nom d'utilisateur (compatibilité avec ancien code)
  set_fact:
    username: "{{ client_name }}"
  tags:
    - adduser
    - config

- name: Générer la clé privée du client
  ansible.builtin.command: wg genkey
  register: client_private_key_cmd
  changed_when: false
  tags:
    - adduser
    - keys

- name: Extraire uniquement la clé privée du client (sans espaces/retours)
  ansible.builtin.set_fact:
    client_private_key_clean: "{{ client_private_key_cmd.stdout | trim }}"
  tags:
    - adduser
    - keys

- name: Générer la clé publique du client depuis la clé privée
  ansible.builtin.shell: echo "{{ client_private_key_clean }}" | wg pubkey
  register: client_public_key_cmd
  changed_when: false
  tags:
    - adduser
    - keys

- name: Extraire uniquement la clé publique du client (sans espaces/retours)
  ansible.builtin.set_fact:
    client_public_key_clean: "{{ client_public_key_cmd.stdout | trim }}"
  tags:
    - adduser
    - keys

- name: Extraire la clé privée du serveur depuis la configuration
  ansible.builtin.shell: grep "^PrivateKey = " {{ wireguard_config_path }}/{{ wireguard_interface }}.conf | awk '{print $3}'
  register: server_private_key_from_file
  changed_when: false
  tags:
    - adduser
    - config

- name: Nettoyer la clé privée du serveur (sans espaces/retours)
  ansible.builtin.set_fact:
    server_private_key_clean: "{{ server_private_key_from_file.stdout | trim }}"
  when: server_private_key_from_file.stdout is defined and server_private_key_from_file.stdout != ""
  tags:
    - adduser
    - config

- name: Générer la clé publique du serveur depuis la clé privée
  ansible.builtin.shell: echo "{{ server_private_key_clean }}" | wg pubkey
  register: server_public_key_generated_cmd
  changed_when: false
  when: server_private_key_clean is defined
  tags:
    - adduser
    - config

- name: Nettoyer la clé publique du serveur générée (sans espaces/retours)
  ansible.builtin.set_fact:
    server_public_key_generated_clean: "{{ server_public_key_generated_cmd.stdout | trim }}"
  when: server_public_key_generated_cmd.stdout is defined
  tags:
    - adduser
    - config

- name: Définir la clé publique du serveur à utiliser (priorité à la variable configurée)
  ansible.builtin.set_fact:
    server_public_key_to_use: "{{ (wireguard_server_public_key | default('', true) | trim) if (wireguard_server_public_key | default('', true) | trim) != '' else server_public_key_generated_clean }}"
  tags:
    - adduser
    - config

- name: Définir l'IP effective pour l'Endpoint WireGuard (si pas déjà définie)
  ansible.builtin.set_fact:
    wireguard_effective_endpoint_ip: "{{ wireguard_server_public_ip | default(ansible_default_ipv4.address, true) }}"
  tags:
    - adduser
    - config

- name: Avertir si l'IP publique n'est pas configurée
  ansible.builtin.debug:
    msg: |
      ⚠️ ATTENTION : wireguard_server_public_ip n'est pas définie dans group_vars/vpn_servers.yml
      L'IP locale ({{ ansible_default_ipv4.address }}) sera utilisée comme Endpoint.
      Pour un client externe en 4G, vous devez définir votre IP publique 4G dans group_vars/vpn_servers.yml
      Trouvez-la avec : curl ifconfig.me (depuis la VM)
      Endpoint utilisé : {{ wireguard_effective_endpoint_ip }}:{{ wireguard_port }}
  when: wireguard_server_public_ip | default('') == ''
  tags:
    - adduser
    - config

- name: Vérifier que toutes les clés sont valides
  ansible.builtin.assert:
    that:
      - client_private_key_clean is defined
      - client_public_key_clean is defined
      - client_private_key_clean | length > 40
      - client_public_key_clean | length > 40
      - server_public_key_to_use is defined
      - server_public_key_to_use | length > 40
    fail_msg: "Erreur lors de la génération des clés WireGuard. Vérifiez les logs."
    success_msg: "Toutes les clés WireGuard sont valides"
  tags:
    - adduser
    - config
    - validation

- name: Créer la configuration client WireGuard
  ansible.builtin.template:
    src: client.conf.j2
    dest: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
    owner: root
    group: root
    mode: '0600'
  vars:
    private_key: "{{ client_private_key_clean }}"
    client_ip: "{{ user_ip }}"
    server_public_key: "{{ server_public_key_to_use }}"
    wireguard_effective_endpoint_ip: "{{ wireguard_effective_endpoint_ip }}"
    wireguard_port: "{{ wireguard_port }}"
  tags:
    - adduser
    - config

- name: Valider la configuration WireGuard générée avec wg-quick strip
  ansible.builtin.command: wg-quick strip "{{ wireguard_clients_path }}/{{ client_name }}.conf"
  register: wg_quick_validation
  changed_when: false
  failed_when: false
  tags:
    - adduser
    - validation

- name: Échouer si la configuration est invalide
  ansible.builtin.fail:
    msg: |
      ❌ Configuration WireGuard invalide pour {{ client_name }}
      Erreur : {{ wg_quick_validation.stderr | default('Format de configuration non valide') }}
      Vérifiez le fichier : {{ wireguard_clients_path }}/{{ client_name }}.conf
      Endpoint utilisé : {{ wireguard_effective_endpoint_ip }}:{{ wireguard_port }}
  when: wg_quick_validation.rc != 0
  tags:
    - adduser
    - validation

- name: Afficher confirmation de validation
  ansible.builtin.debug:
    msg: "✅ Configuration WireGuard validée avec succès (wg-quick strip)"
  when: wg_quick_validation.rc == 0
  tags:
    - adduser
    - validation

- name: Générer le QR code de la configuration
  ansible.builtin.script: scripts/generate_qr.sh
  args:
    creates: "{{ wireguard_qr_path }}/{{ client_name }}.png"
  environment:
    CONFIG_FILE: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
    QR_FILE: "{{ wireguard_qr_path }}/{{ client_name }}.png"
  tags:
    - adduser
    - qr

- name: Vérifier si un peer existe déjà pour cette IP
  ansible.builtin.shell: grep -c "AllowedIPs = {{ user_ip }}/32" {{ wireguard_config_path }}/{{ wireguard_interface }}.conf || echo "0"
  register: peer_exists_count
  changed_when: false
  failed_when: false
  tags:
    - adduser
    - config

- name: Supprimer l'ancien peer s'il existe (méthode robuste avec sed)
  become: true
  shell: |
    set -e

    CONFIG_FILE="{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    CLIENT_IP="{{ user_ip }}"

    # Si le fichier n'existe pas, on sort proprement
    if [ ! -f "$CONFIG_FILE" ]; then
      exit 0
    fi

    # Trouver la ligne contenant l'AllowedIPs pour cette IP
    LINE_NUM=$(grep -n "AllowedIPs = ${CLIENT_IP}/32" "$CONFIG_FILE" | head -1 | cut -d: -f1 || echo "")

    if [ -n "$LINE_NUM" ]; then
      # Remonter jusqu'au début du bloc [Peer]
      START_LINE=$LINE_NUM
      while [ $START_LINE -gt 1 ]; do
        START_LINE=$((START_LINE - 1))
        if sed -n "${START_LINE}p" "$CONFIG_FILE" | grep -q "^\[Peer\]"; then
          break
        fi
      done

      # Descendre jusqu'à la fin du bloc (ligne vide, prochain [Peer] ou fin de fichier)
      END_LINE=$LINE_NUM
      TOTAL_LINES=$(wc -l < "$CONFIG_FILE")
      while [ $END_LINE -lt $TOTAL_LINES ]; do
        END_LINE=$((END_LINE + 1))
        LINE_CONTENT=$(sed -n "${END_LINE}p" "$CONFIG_FILE")
        if [ -z "$LINE_CONTENT" ] || echo "$LINE_CONTENT" | grep -q "^\[Peer\]"; then
          END_LINE=$((END_LINE - 1))
          break
        fi
      done

      # Supprimer le bloc [Peer]
      sed -i "${START_LINE},${END_LINE}d" "$CONFIG_FILE"

      # Nettoyer les lignes vides multiples
      sed -i '/^$/N;/^\n$/d' "$CONFIG_FILE"
    fi
  args:
    executable: /bin/bash
  when:
    - user_ip is defined
    - user_ip != ""
    - peer_exists_count.stdout | int > 0
  changed_when: peer_exists_count.stdout | int > 0
  tags:
    - adduser
    - config

- name: Ajouter le peer au fichier de configuration du serveur (ligne par ligne pour éviter les problèmes de format)
  ansible.builtin.lineinfile:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    line: "{{ item }}"
    insertafter: EOF
    backup: yes
  loop:
    - ""
    - "[Peer]"
    - "# Client: {{ client_name }} (role: {{ user_role }})"
    - "PublicKey = {{ client_public_key_clean }}"
    - "AllowedIPs = {{ user_ip }}/32"
  notify: reload wireguard
  tags:
    - adduser
    - config

- name: Forcer le reload de WireGuard pour s'assurer que le handler s'exécute
  ansible.builtin.command: wg syncconf {{ wireguard_interface }} {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
  changed_when: true
  tags:
    - adduser
    - config

- name: Attendre que WireGuard soit prêt après reload
  ansible.builtin.pause:
    seconds: 1
  tags:
    - adduser
    - validation

- name: Vérifier la cohérence du peer dans wg0 après reload
  ansible.builtin.command: wg show {{ wireguard_interface }} dump
  register: wg_show_output
  changed_when: false
  tags:
    - adduser
    - validation

- name: "Extraire l'entrée du peer depuis wg show dump (format pubkey endpoint allowed_ips)"
  ansible.builtin.set_fact:
    peer_entry_raw: "{{ wg_show_output.stdout_lines | select('match', '^' + client_public_key_clean + '.*') | list | first | default('') }}"
  tags:
    - adduser
    - validation

- name: Vérifier que le peer est présent avec la bonne clé publique
  ansible.builtin.assert:
    that:
      - peer_entry_raw != ""
      - client_public_key_clean in peer_entry_raw
      - user_ip in peer_entry_raw
    fail_msg: |
      ❌ ERREUR : Le peer n'a pas été correctement configuré dans wg0.conf
      
      Clé publique client attendue : {{ client_public_key_clean }}
      IP VPN attendue : {{ user_ip }}
      
      Actions à vérifier :
      1. Vérifiez le fichier : {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
      2. La clé publique dans le bloc [Peer] doit être : {{ client_public_key_clean }}
      3. AllowedIPs doit être : {{ user_ip }}/32
      4. Relancez : wg syncconf {{ wireguard_interface }} {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
      
      Entrée trouvée dans wg show : {{ peer_entry_raw | default('AUCUNE - peer non trouvé') }}
      Toutes les entrées wg show : {{ wg_show_output.stdout_lines }}
    success_msg: "✅ Peer correctement configuré et actif dans wg0 (clé: {{ client_public_key_clean[:20] }}..., IP: {{ user_ip }})"
  tags:
    - adduser
    - validation

- name: Inclure la gestion des rôles
  ansible.builtin.include_tasks: manage_roles.yml
  tags:
    - adduser
    - roles

- name: Ajouter règle UFW pour accès services internes si rôle=allowed
  ansible.builtin.command: ufw allow from {{ user_ip }} to any port {{ item }} proto tcp
  loop:
    - 80   # Nginx interne
    - 443  # HTTPS interne
    - 3000 # Grafana
  when: user_role == "allowed"
  changed_when: true
  tags:
    - adduser
    - firewall

- name: Ajouter règle UFW pour accès complet si rôle=admin
  ansible.builtin.command: ufw allow from {{ user_ip }} to any port {{ item }} proto tcp
  loop:
    - 80   # Nginx interne
    - 443  # HTTPS interne
    - 3000 # Grafana
    - 9090 # Prometheus
  when: user_role == "admin"
  changed_when: true
  tags:
    - adduser
    - firewall

- name: Aucune règle UFW pour rôle restricted
  ansible.builtin.debug:
    msg: "Aucune règle UFW ajoutée - accès VPN uniquement (rôle: restricted)"
  when: user_role == "restricted"
  tags:
    - adduser
    - firewall

- name: Vérifier que le fichier de configuration a été créé
  stat:
    path: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
  register: conf_file_stat
  tags:
    - adduser
    - check

- name: Vérifier que le QR code a été généré
  stat:
    path: "{{ wireguard_qr_path }}/{{ client_name }}.png"
  register: qr_file_stat
  tags:
    - adduser
    - check

- name: Afficher un résumé de la création
  ansible.builtin.debug:
    msg:
      - "✅ Client {{ client_name }} créé avec succès"
      - "Clé publique client: {{ client_public_key_clean }}"
      - "Clé publique serveur: {{ server_public_key_to_use }}"
      - "IP VPN: {{ user_ip }}"
      - "Endpoint: {{ wireguard_effective_endpoint_ip }}:{{ wireguard_port }}"
      - "Rôle: {{ user_role }}"
      - "Fichier config: {{ wireguard_clients_path }}/{{ client_name }}.conf"
      - "QR Code: {{ wireguard_qr_path }}/{{ client_name }}.png"
      - "Peer ajouté dans: {{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
      - "Règles UFW: {{ 'Aucune (VPN seul)' if user_role == 'restricted' else ('Ports 80/443/3000 (services internes)' if user_role == 'allowed' else 'Ports 80/443/3000/9090 (accès complet)') }}"
  tags:
    - adduser
    - info
