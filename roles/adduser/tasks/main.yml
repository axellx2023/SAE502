---
# Rôle AddUser - Ajout d'un client VPN avec génération de clés, QR code et gestion des rôles
- name: Vérifier que le répertoire des clients existe
  file:
    path: "{{ wireguard_clients_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - adduser
    - config

- name: Vérifier que le répertoire QR existe
  file:
    path: "{{ wireguard_qr_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - adduser
    - config

- name: Définir le nom d'utilisateur (compatibilité avec ancien code)
  set_fact:
    username: "{{ client_name }}"
  tags:
    - adduser
    - config

- name: Générer la clé privée du client
  ansible.builtin.command: wg genkey
  register: client_private_key_cmd
  changed_when: false
  tags:
    - adduser
    - keys

- name: Extraire uniquement la clé privée du client (sans espaces/retours)
  ansible.builtin.set_fact:
    client_private_key_clean: "{{ client_private_key_cmd.stdout | trim }}"
  tags:
    - adduser
    - keys

- name: Générer la clé publique du client depuis la clé privée
  ansible.builtin.shell: echo "{{ client_private_key_clean }}" | wg pubkey
  register: client_public_key_cmd
  changed_when: false
  tags:
    - adduser
    - keys

- name: Extraire uniquement la clé publique du client (sans espaces/retours)
  ansible.builtin.set_fact:
    client_public_key_clean: "{{ client_public_key_cmd.stdout | trim }}"
  tags:
    - adduser
    - keys

- name: Extraire la clé privée du serveur depuis la configuration
  ansible.builtin.shell: grep "^PrivateKey = " {{ wireguard_config_path }}/{{ wireguard_interface }}.conf | awk '{print $3}'
  register: server_private_key_from_file
  changed_when: false
  tags:
    - adduser
    - config

- name: Nettoyer la clé privée du serveur (sans espaces/retours)
  ansible.builtin.set_fact:
    server_private_key_clean: "{{ server_private_key_from_file.stdout | trim }}"
  when: server_private_key_from_file.stdout is defined and server_private_key_from_file.stdout != ""
  tags:
    - adduser
    - config

- name: Générer la clé publique du serveur depuis la clé privée
  ansible.builtin.shell: echo "{{ server_private_key_clean }}" | wg pubkey
  register: server_public_key_generated_cmd
  changed_when: false
  when: server_private_key_clean is defined
  tags:
    - adduser
    - config

- name: Nettoyer la clé publique du serveur générée (sans espaces/retours)
  ansible.builtin.set_fact:
    server_public_key_generated_clean: "{{ server_public_key_generated_cmd.stdout | trim }}"
  when: server_public_key_generated_cmd.stdout is defined
  tags:
    - adduser
    - config

- name: Définir la clé publique du serveur à utiliser (priorité à la variable configurée)
  ansible.builtin.set_fact:
    server_public_key_to_use: "{{ (wireguard_server_public_key | default('', true) | trim) if (wireguard_server_public_key | default('', true) | trim) != '' else server_public_key_generated_clean }}"
  tags:
    - adduser
    - config

- name: Définir l'IP effective pour l'Endpoint WireGuard (si pas déjà définie)
  ansible.builtin.set_fact:
    wireguard_effective_endpoint_ip: "{{ wireguard_server_public_ip | default(ansible_default_ipv4.address, true) }}"
  tags:
    - adduser
    - config

- name: Avertir si l'IP publique n'est pas configurée
  ansible.builtin.debug:
    msg: |
      ⚠️ ATTENTION : wireguard_server_public_ip n'est pas définie dans group_vars/vpn_servers.yml
      L'IP locale ({{ ansible_default_ipv4.address }}) sera utilisée comme Endpoint.
      Pour un client externe en 4G, vous devez définir votre IP publique 4G dans group_vars/vpn_servers.yml
      Trouvez-la avec : curl ifconfig.me (depuis la VM)
      Endpoint utilisé : {{ wireguard_effective_endpoint_ip }}:{{ wireguard_port }}
  when: wireguard_server_public_ip | default('') == ''
  tags:
    - adduser
    - config

- name: Vérifier que toutes les clés sont valides
  ansible.builtin.assert:
    that:
      - client_private_key_clean is defined
      - client_public_key_clean is defined
      - client_private_key_clean | length > 40
      - client_public_key_clean | length > 40
      - server_public_key_to_use is defined
      - server_public_key_to_use | length > 40
    fail_msg: "Erreur lors de la génération des clés WireGuard. Vérifiez les logs."
    success_msg: "Toutes les clés WireGuard sont valides"
  tags:
    - adduser
    - config
    - validation

- name: Créer la configuration client WireGuard
  ansible.builtin.template:
    src: client.conf.j2
    dest: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
    owner: root
    group: root
    mode: '0600'
  vars:
    private_key: "{{ client_private_key_clean }}"
    client_ip: "{{ user_ip }}"
    server_public_key: "{{ server_public_key_to_use }}"
    wireguard_effective_endpoint_ip: "{{ wireguard_effective_endpoint_ip }}"
  tags:
    - adduser
    - config

- name: Normaliser automatiquement le format du fichier client (Clé=Valeur → Clé = Valeur)
  ansible.builtin.replace:
    path: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
    # Corrige toutes les lignes avec = collé (sans espaces) : Address= → Address = 
    # Exclut automatiquement les lignes qui ont déjà des espaces autour du =
    regexp: '^(\s*[A-Za-z][A-Za-z0-9]*)=(.+)$'
    replace: '\1 = \2'
  tags:
    - adduser
    - config
    - validation

- name: Valider la configuration WireGuard générée avec wg-quick strip
  ansible.builtin.command: wg-quick strip "{{ wireguard_clients_path }}/{{ client_name }}.conf"
  register: wg_quick_validation
  changed_when: false
  failed_when: false
  tags:
    - adduser
    - validation

- name: Échouer si la configuration est invalide
  ansible.builtin.fail:
    msg: |
      ❌ Configuration WireGuard invalide pour {{ client_name }}
      Erreur : {{ wg_quick_validation.stderr | default('Format de configuration non valide') }}
      Vérifiez le fichier : {{ wireguard_clients_path }}/{{ client_name }}.conf
      Endpoint utilisé : {{ wireguard_effective_endpoint_ip }}:{{ wireguard_port }}
  when: wg_quick_validation.rc != 0
  tags:
    - adduser
    - validation

- name: Afficher confirmation de validation
  ansible.builtin.debug:
    msg: "✅ Configuration WireGuard validée avec succès (wg-quick strip)"
  when: wg_quick_validation.rc == 0
  tags:
    - adduser
    - validation

- name: Générer le QR code de la configuration
  ansible.builtin.script: scripts/generate_qr.sh
  args:
    creates: "{{ wireguard_qr_path }}/{{ client_name }}.png"
  environment:
    CONFIG_FILE: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
    QR_FILE: "{{ wireguard_qr_path }}/{{ client_name }}.png"
  tags:
    - adduser
    - qr

- name: Vérifier si un peer existe déjà pour cette IP
  ansible.builtin.shell: grep -c "AllowedIPs = {{ user_ip }}/32" {{ wireguard_config_path }}/{{ wireguard_interface }}.conf || echo "0"
  register: peer_exists_count
  changed_when: false
  failed_when: false
  tags:
    - adduser
    - config

- name: Supprimer l'ancien peer s'il existe (méthode robuste avec sed)
  become: true
  shell: |
    set -e

    CONFIG_FILE="{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    CLIENT_IP="{{ user_ip }}"

    # Si le fichier n'existe pas, on sort proprement
    if [ ! -f "$CONFIG_FILE" ]; then
      exit 0
    fi

    # Trouver la ligne contenant l'AllowedIPs pour cette IP
    LINE_NUM=$(grep -n "AllowedIPs = ${CLIENT_IP}/32" "$CONFIG_FILE" | head -1 | cut -d: -f1 || echo "")

    if [ -n "$LINE_NUM" ]; then
      # Remonter jusqu'au début du bloc [Peer]
      START_LINE=$LINE_NUM
      while [ $START_LINE -gt 1 ]; do
        START_LINE=$((START_LINE - 1))
        if sed -n "${START_LINE}p" "$CONFIG_FILE" | grep -q "^\[Peer\]"; then
          break
        fi
      done

      # Descendre jusqu'à la fin du bloc (ligne vide, prochain [Peer] ou fin de fichier)
      END_LINE=$LINE_NUM
      TOTAL_LINES=$(wc -l < "$CONFIG_FILE")
      while [ $END_LINE -lt $TOTAL_LINES ]; do
        END_LINE=$((END_LINE + 1))
        LINE_CONTENT=$(sed -n "${END_LINE}p" "$CONFIG_FILE")
        if [ -z "$LINE_CONTENT" ] || echo "$LINE_CONTENT" | grep -q "^\[Peer\]"; then
          END_LINE=$((END_LINE - 1))
          break
        fi
      done

      # Supprimer le bloc [Peer]
      sed -i "${START_LINE},${END_LINE}d" "$CONFIG_FILE"

      # Nettoyer les lignes vides multiples
      sed -i '/^$/N;/^\n$/d' "$CONFIG_FILE"
    fi
  args:
    executable: /bin/bash
  when:
    - user_ip is defined
    - user_ip != ""
    - peer_exists_count.stdout | int > 0
  changed_when: peer_exists_count.stdout | int > 0
  tags:
    - adduser
    - config

- name: Nettoyer les IPs invalides (10.8.0.0.X) dans wg0.conf AVANT d'ajouter le nouveau peer
  ansible.builtin.replace:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    regexp: 'AllowedIPs = 10\.8\.0\.0\.([0-9]+)/32'
    replace: 'AllowedIPs = 10.8.0.\1/32'
  tags:
    - adduser
    - config
    - fix

- name: Vérifier que l'IP du client est valide avant ajout
  ansible.builtin.assert:
    that:
      - user_ip | regex_search('^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$')
      - user_ip | regex_search('^10\.8\.0\.[0-9]+$')
    fail_msg: "ERREUR : IP invalide détectée : {{ user_ip }}. L'IP doit être au format 10.8.0.X. Le préfixe réseau est peut-être incorrect."
    success_msg: "IP valide : {{ user_ip }}"
  tags:
    - adduser
    - config

- name: Ajouter le peer au fichier de configuration du serveur (ligne par ligne pour éviter les problèmes de format)
  ansible.builtin.lineinfile:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    line: "{{ item }}"
    insertafter: EOF
    backup: yes
  loop:
    - ""
    - "[Peer]"
    - "# Client: {{ client_name }} (role: {{ user_role }})"
    - "PublicKey = {{ client_public_key_clean }}"
    - "AllowedIPs = {{ user_ip }}/32"
  notify: restart wireguard
  tags:
    - adduser
    - config

- name: Nettoyer à nouveau les IPs invalides après ajout du peer (sécurité)
  ansible.builtin.replace:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    regexp: 'AllowedIPs = 10\.8\.0\.0\.([0-9]+)/32'
    replace: 'AllowedIPs = 10.8.0.\1/32'
  tags:
    - adduser
    - config
    - validation
    - fix

- name: Supprimer les blocs [Peer] avec IPs invalides (10.8.0.0.X)
  ansible.builtin.shell: |
    set -e
    CONFIG_FILE="{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    if [ -f "$CONFIG_FILE" ]; then
      # Créer un fichier temporaire
      TEMP_FILE=$(mktemp)
      # Supprimer les blocs [Peer] contenant des IPs invalides
      awk '
        /^\[Peer\]/ { in_peer=1; peer_lines=""; peer_start=NR }
        in_peer { peer_lines=peer_lines $0 "\n" }
        /^AllowedIPs = 10\.8\.0\.0\.[0-9]+\/32/ { skip_peer=1 }
        /^$/ && in_peer { 
          if (!skip_peer) print peer_lines
          in_peer=0; skip_peer=0; peer_lines=""
        }
        !in_peer && !/^\[Peer\]/ { print }
        END { if (in_peer && !skip_peer) print peer_lines }
      ' "$CONFIG_FILE" > "$TEMP_FILE"
      mv "$TEMP_FILE" "$CONFIG_FILE"
    fi
  args:
    executable: /bin/bash
  changed_when: true
  tags:
    - adduser
    - config
    - validation
    - fix

- name: Normaliser automatiquement le format du fichier wg0.conf (Clé=Valeur → Clé = Valeur)
  ansible.builtin.replace:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    # Corrige toutes les lignes avec = collé (sans espaces) : Address= → Address = 
    # Le module replace remplace déjà toutes les occurrences par défaut
    regexp: '^(\s*[A-Za-z][A-Za-z0-9]*)=(.+)$'
    replace: '\1 = \2'
  tags:
    - adduser
    - config
    - validation

- name: Forcer le format correct de la ligne Address dans wg0.conf (garantit Address = ...)
  ansible.builtin.lineinfile:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    regexp: '^\s*Address\s*='
    line: "Address = {{ wireguard_server_ip }}/24"
    backrefs: no
  tags:
    - adduser
    - config
    - validation

- name: Forcer le format correct de la ligne ListenPort dans wg0.conf (garantit ListenPort = ...)
  ansible.builtin.lineinfile:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    regexp: '^\s*ListenPort\s*='
    line: "ListenPort = {{ wireguard_port }}"
    backrefs: no
  tags:
    - adduser
    - config
    - validation

- name: Forcer le format correct de la ligne PrivateKey dans wg0.conf (si présente)
  ansible.builtin.replace:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    # Corrige PrivateKey= ou PrivateKey = (sans espaces ou avec espaces incorrects)
    # Le module replace remplace déjà toutes les occurrences par défaut
    regexp: '^(\s*PrivateKey)\s*=\s*(.+)$'
    replace: '\1 = \2'
  tags:
    - adduser
    - config
    - validation

- name: Forcer le format correct de toutes les lignes PublicKey dans les blocs [Peer]
  ansible.builtin.replace:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    # Corrige les lignes PublicKey= dans les blocs [Peer]
    # Le module replace remplace déjà toutes les occurrences par défaut
    regexp: '^(\s*PublicKey)\s*=\s*(.+)$'
    replace: '\1 = \2'
  tags:
    - adduser
    - config
    - validation

- name: Forcer le format correct de toutes les lignes AllowedIPs dans les blocs [Peer]
  ansible.builtin.replace:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    # Corrige les lignes AllowedIPs=
    # Le module replace remplace déjà toutes les occurrences par défaut
    regexp: '^(\s*AllowedIPs)\s*=\s*(.+)$'
    replace: '\1 = \2'
  tags:
    - adduser
    - config
    - validation

- name: Valider le format du fichier wg0.conf avant reload
  ansible.builtin.command: wg-quick strip {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
  register: wg_quick_validate
  changed_when: false
  failed_when: false
  tags:
    - adduser
    - config
    - validation

- name: Échouer si le fichier wg0.conf est toujours invalide après normalisation
  ansible.builtin.fail:
    msg: |-
      ❌ ERREUR : Le fichier wg0.conf a un format invalide après normalisation

      Fichier : {{ wireguard_config_path }}/{{ wireguard_interface }}.conf

      Sortie wg-quick strip :
      {{ wg_quick_validate.stderr | default(wg_quick_validate.stdout) }}

      Actions recommandées :
      1. Vérifiez le fichier : sudo cat {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
      2. Recherchez les lignes mal formatées (notamment Address=, ListenPort=, PrivateKey=)
      3. Relancez le playbook deploy.yml pour régénérer le fichier proprement :
         ansible-playbook -i inventory.ini deploy.yml --ask-become-pass
      4. OU corrigez manuellement le fichier en respectant le format WireGuard :
         [Interface]
         Address = {{ wireguard_server_ip }}/24
         ListenPort = {{ wireguard_port }}
         PrivateKey = ...
  when: wg_quick_validate.rc != 0
  tags:
    - adduser
    - config
    - validation

- name: Appliquer immédiatement les handlers WireGuard
  meta: flush_handlers
  tags:
    - adduser
    - config
    - validation

- name: Attendre que WireGuard soit prêt après redémarrage
  ansible.builtin.pause:
    seconds: 2
  tags:
    - adduser
    - validation

- name: Vérifier la cohérence du peer dans wg0 après redémarrage
  ansible.builtin.command: wg show {{ wireguard_interface }} dump
  register: wg_show_output
  changed_when: false
  tags:
    - adduser
    - validation

- name: "Extraire l'entrée du peer depuis wg show dump (format pubkey endpoint allowed_ips)"
  ansible.builtin.set_fact:
    peer_entry_raw: "{{ wg_show_output.stdout_lines | select('match', '^' + client_public_key_clean + '.*') | list | first | default('') }}"
  tags:
    - adduser
    - validation

- name: Vérifier que le peer est présent avec la bonne clé publique (check non bloquant)
  ansible.builtin.assert:
    that:
      - peer_entry_raw != ""
      - client_public_key_clean in peer_entry_raw
      - user_ip in peer_entry_raw
    success_msg: "✅ Peer détecté dans wg show (clé et IP correctes)."
    fail_msg: |-
      ⚠️ ATTENTION : Le peer n'a pas été trouvé dans wg show dump, mais la configuration a été appliquée.
      
      Clé publique attendue : {{ client_public_key_clean }}
      IP VPN attendue : {{ user_ip }}/32
      
      Entrée trouvée dans wg show : {{ peer_entry_raw | default('AUCUNE - peer non trouvé') }}
      Toutes les entrées wg show : {{ wg_show_output.stdout_lines }}
      
      Note : La configuration est présente dans wg0.conf et le service a été redémarré.
      Le peer peut apparaître après quelques secondes ou nécessiter une nouvelle connexion.
  failed_when: false
  changed_when: false
  tags:
    - adduser
    - validation

- name: Inclure la gestion des rôles
  ansible.builtin.include_tasks: manage_roles.yml
  tags:
    - adduser
    - roles

- name: Vérifier si les règles UFW existent déjà pour cet utilisateur
  ansible.builtin.shell: ufw status numbered | grep -c "{{ user_ip }}" || echo "0"
  register: ufw_rules_exist
  changed_when: false
  failed_when: false
  tags:
    - adduser
    - firewall

- name: Ajouter règle UFW pour accès services internes si rôle=allowed (si pas déjà présente)
  ansible.builtin.command: ufw allow from {{ user_ip }} to any port {{ item }} proto tcp
  loop:
    - "{{ nginx_port }}" # Nginx interne
    - "{{ grafana_port }}" # Grafana
  when: 
    - user_role == "allowed"
    - ufw_rules_exist.stdout | int == 0
  changed_when: true
  tags:
    - adduser
    - firewall

- name: Ajouter règle UFW pour accès complet si rôle=admin (si pas déjà présente)
  ansible.builtin.command: ufw allow from {{ user_ip }} to any port {{ item }} proto tcp
  loop:
    - "{{ nginx_port }}" # Nginx interne
    - "{{ grafana_port }}" # Grafana
    - "{{ prometheus_port }}" # Prometheus
  when: 
    - user_role == "admin"
    - ufw_rules_exist.stdout | int == 0
  changed_when: true
  tags:
    - adduser
    - firewall

- name: Aucune règle UFW pour rôle restricted
  ansible.builtin.debug:
    msg: "Aucune règle UFW ajoutée - accès VPN uniquement (rôle: restricted)"
  when: user_role == "restricted"
  tags:
    - adduser
    - firewall

- name: Vérifier que le fichier de configuration a été créé
  stat:
    path: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
  register: conf_file_stat
  tags:
    - adduser
    - check

- name: Vérifier que le QR code a été généré
  stat:
    path: "{{ wireguard_qr_path }}/{{ client_name }}.png"
  register: qr_file_stat
  tags:
    - adduser
    - check

- name: Afficher un résumé de la création
  ansible.builtin.debug:
    msg:
      - "✅ Client {{ client_name }} créé avec succès"
      - "Clé publique client: {{ client_public_key_clean }}"
      - "Clé publique serveur: {{ server_public_key_to_use }}"
      - "IP VPN: {{ user_ip }}"
      - "Endpoint: {{ wireguard_effective_endpoint_ip }}:{{ wireguard_port }}"
      - "Rôle: {{ user_role }}"
      - "Fichier config: {{ wireguard_clients_path }}/{{ client_name }}.conf"
      - "QR Code: {{ wireguard_qr_path }}/{{ client_name }}.png"
      - "Peer ajouté dans: {{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
      - "Règles UFW: {{ 'Aucune (VPN seul)' if user_role == 'restricted' else ('Ports 8080/3000 (services internes)' if user_role == 'allowed' else 'Ports 8080/3000/9090 (accès complet)') }}"
  tags:
    - adduser
    - info
