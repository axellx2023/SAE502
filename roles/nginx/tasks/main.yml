---
# Rôle Nginx - Service interne accessible uniquement via VPN + Reverse proxy avec Basic Auth
# ============================================================================
# SECTION 1 : Nginx sur l'hôte pour protéger le WebUI avec Basic Auth
# ============================================================================
- name: Installer Nginx sur l'hôte
  ansible.builtin.apt:
    name:
      - nginx
      - apache2-utils  # Pour htpasswd
    state: present
    update_cache: yes
  tags:
    - nginx
    - nginx-host
    - install

- name: Créer le répertoire pour les fichiers d'authentification Nginx
  ansible.builtin.file:
    path: /etc/nginx
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - nginx
    - nginx-host
    - config

- name: Vérifier si le fichier htpasswd existe
  ansible.builtin.stat:
    path: /etc/nginx/.wg_auth
  register: htpasswd_file
  tags:
    - nginx
    - nginx-host
    - config
    - auth

- name: Créer le fichier htpasswd pour Basic Auth (utilisateur admin par défaut)
  ansible.builtin.command: htpasswd -b -c /etc/nginx/.wg_auth admin admin
  when: not htpasswd_file.stat.exists
  tags:
    - nginx
    - nginx-host
    - config
    - auth

- name: Ajouter l'utilisateur admin au fichier htpasswd si le fichier existe mais sans admin
  ansible.builtin.command: htpasswd -b /etc/nginx/.wg_auth admin admin
  when: htpasswd_file.stat.exists
  tags:
    - nginx
    - nginx-host
    - config
    - auth

- name: Sécuriser le fichier htpasswd
  ansible.builtin.file:
    path: /etc/nginx/.wg_auth
    owner: root
    group: www-data
    mode: '0640'
  tags:
    - nginx
    - nginx-host
    - config
    - auth

- name: Créer la configuration Nginx pour le reverse-proxy WebUI
  ansible.builtin.template:
    src: wireguard-manager.conf.j2
    dest: /etc/nginx/sites-available/wireguard-manager
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx
  tags:
    - nginx
    - nginx-host
    - config

- name: Désactiver le site par défaut Nginx si présent
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  tags:
    - nginx
    - nginx-host
    - config

- name: Activer le site Nginx wireguard-manager (default_server)
  ansible.builtin.file:
    src: /etc/nginx/sites-available/wireguard-manager
    dest: /etc/nginx/sites-enabled/wireguard-manager
    state: link
    force: yes
  tags:
    - nginx
    - nginx-host
    - config

- name: Valider la configuration Nginx
  ansible.builtin.command: nginx -t
  register: nginx_test
  changed_when: false
  failed_when: nginx_test.rc != 0
  tags:
    - nginx
    - nginx-host
    - config

- name: Démarrer et activer Nginx
  ansible.builtin.systemd:
    name: nginx
    enabled: yes
    state: started
    daemon_reload: yes
  tags:
    - nginx
    - nginx-host
    - service

- name: Afficher les informations d'accès au WebUI protégé
  ansible.builtin.debug:
    msg: |-
      ✅ Nginx reverse-proxy configuré avec Basic Auth
      
      Accès WebUI protégé : http://{{ ansible_default_ipv4.address }}:80
      Authentification : admin / admin
      
      Note : Le port 5000 Flask reste accessible en localhost uniquement.
      Tous les accès externes passent maintenant par Nginx sur le port 80 avec authentification.
      
      Pour ajouter un utilisateur :
        sudo htpasswd /etc/nginx/.wg_auth username
      
      Pour modifier le mot de passe :
        sudo htpasswd /etc/nginx/.wg_auth admin
  tags:
    - nginx
    - nginx-host
    - info

# ============================================================================
# SECTION 2 : Service interne Nginx (Docker) - Accessible uniquement via VPN
# ============================================================================
- name: Créer le répertoire web pour Nginx
  file:
    path: "{{ nginx_web_root }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - nginx
    - nginx-docker
    - config

- name: Créer une page d'accueil pour le service interne
  copy:
    content: |
      <!DOCTYPE html>
      <html lang="fr">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Espace interne VPN - SAE502</title>
          <style>
              .container {
                  max-width: 900px;
                  margin: 0 auto;
                  background: #111827;
                  border: 1px solid #1f2937;
                  border-radius: 12px;
                  padding: 28px;
                  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
              }
              * {
                  margin: 0;
                  padding: 0;
                  box-sizing: border-box;
              }
              body {
                  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                  background: #0b1320;
                  color: #e6edf3;
                  min-height: 100vh;
                  padding: 24px;
              }
              h1 {
                  font-size: 1.8em;
                  margin-bottom: 16px;
                  color: #7dd3fc;
              }
              .badge {
                  display: inline-block;
                  background: #14532d;
                  color: #dcfce7;
                  padding: 6px 12px;
                  border-radius: 999px;
                  font-weight: bold;
                  margin-bottom: 16px;
                  font-size: 0.9em;
              }
              .section {
                  background: #0f172a;
                  border: 1px solid #1e293b;
                  border-radius: 8px;
                  padding: 16px;
                  margin-top: 16px;
              }
              .section h2 {
                  color: #93c5fd;
                  margin-bottom: 8px;
                  font-size: 1.2em;
              }
              p {
                  line-height: 1.6;
                  color: #cbd5f5;
                  margin-bottom: 8px;
              }
              ul {
                  margin-left: 20px;
                  margin-top: 8px;
              }
              li {
                  margin-bottom: 6px;
                  line-height: 1.5;
              }
              .footer {
                  margin-top: 18px;
                  font-size: 0.85em;
                  color: #94a3b8;
              }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>Espace interne VPN - SAE502</h1>
              <div class="badge">Acces VPN requis (roles allowed/admin)</div>

              <div class="section">
                  <h2>SAE502 - Deploiement automatise d'un serveur VPN WireGuard avec Ansible</h2>
                  <p>Ce projet Ansible permet de deployer automatiquement un serveur VPN WireGuard complet sur Ubuntu avec supervision (Prometheus + Grafana) et interface web de gestion.</p>
                  <p>Table des matieres :</p>
                  <ul>
                      <li>Architecture</li>
                      <li>Prerequis</li>
                      <li>Installation</li>
                      <li>Utilisation</li>
                      <li>Structure du projet</li>
                      <li>Configuration</li>
                      <li>Securite</li>
                      <li>Depannage</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>Architecture</h2>
                  <p>Le projet deploye une infrastructure complete comprenant :</p>
                  <ul>
                      <li>WireGuard : Serveur VPN installe directement sur la VM</li>
                      <li>Docker + Docker Compose : Pour les services conteneurises</li>
                      <li>Nginx : Service interne accessible uniquement via VPN</li>
                      <li>WebUI (Flask) : Interface web pour telecharger les configurations et QR codes</li>
                      <li>Prometheus : Collecte de metriques</li>
                      <li>WireGuard Exporter : Export des metriques WireGuard vers Prometheus</li>
                      <li>Grafana : Visualisation des metriques et supervision</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>Prerequis</h2>
                  <p>Sur la machine de controle (ou vous executez Ansible) :</p>
                  <ul>
                      <li>Ansible 2.9 ou superieur</li>
                      <li>Python 3</li>
                      <li>Acces SSH a la VM Ubuntu cible</li>
                  </ul>
                  <p>Sur la VM Ubuntu cible :</p>
                  <ul>
                      <li>Ubuntu 20.04 LTS ou superieur</li>
                      <li>Acces SSH avec privileges sudo</li>
                      <li>Connexion Internet</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>Installation</h2>
                  <p>1. Cloner ou telecharger le projet :</p>
                  <pre>cd SAE502</pre>
                  <p>2. Configurer l'inventaire (inventory.ini) :</p>
                  <pre>[vpn_servers]<br>192.168.1.100  # Remplacez par l'IP de votre serveur<br><br>[vpn_servers:vars]<br>ansible_user=ubuntu<br>ansible_ssh_common_args='-o StrictHostKeyChecking=no'</pre>
                  <p>3. Configurer les variables dans group_vars/vpn_servers.yml :</p>
                  <ul>
                      <li>Ports des services</li>
                      <li>Mots de passe (utilisez ansible-vault pour les secrets)</li>
                      <li>Chemins de stockage</li>
                      <li>Configuration reseau WireGuard</li>
                  </ul>
                  <p>4. Chiffrer les secrets (recommande) :</p>
                  <pre>ansible-vault create group_vars/vpn_servers_vault.yml<br># wireguard_server_private_key: "votre_cle_privee"<br># webui_secret_key: "votre_secret_flask"<br># grafana_admin_password: "votre_mot_de_passe_grafana"</pre>
                  <p>5. Tester la connexion :</p>
                  <pre>ansible vpn_servers -m ping</pre>
              </div>

              <div class="section">
                  <h2>Utilisation</h2>
                  <p>Deploiement complet :</p>
                  <pre>ansible-playbook deploy.yml</pre>
                  <p>Ce playbook va :</p>
                  <ul>
                      <li>Installer WireGuard et generer les cles serveur</li>
                      <li>Installer Docker et Docker Compose</li>
                      <li>Deployer tous les conteneurs (Nginx, WebUI, Prometheus, Grafana)</li>
                      <li>Configurer le firewall</li>
                      <li>Securiser le systeme</li>
                  </ul>
                  <p>Ajouter un nouvel utilisateur VPN :</p>
                  <pre>ansible-playbook add_user.yml -e username=john -e user_ip=10.8.0.2</pre>
                  <p>Important : chaque utilisateur doit avoir une IP unique dans le reseau VPN.</p>
                  <p>Verifier l'etat des services :</p>
                  <pre>ansible-playbook check.yml</pre>
              </div>

              <div class="section">
                  <h2>Structure du projet</h2>
                  <pre>SAE502/<br>├── ansible.cfg<br>├── inventory.ini<br>├── deploy.yml<br>├── add_user.yml<br>├── check.yml<br>├── group_vars/<br>│   └── vpn_servers.yml<br>├── roles/<br>│   ├── wireguard/<br>│   ├── docker/<br>│   ├── nginx/<br>│   ├── webui/<br>│   ├── prometheus/<br>│   ├── grafana/<br>│   ├── adduser/<br>│   └── check/<br>└── README.md</pre>
              </div>

              <div class="section">
                  <h2>Configuration</h2>
                  <p>Variables principales dans group_vars/vpn_servers.yml :</p>
                  <ul>
                      <li>wireguard_port</li>
                      <li>wireguard_network</li>
                      <li>webui_port</li>
                      <li>prometheus_port</li>
                      <li>grafana_port</li>
                  </ul>
                  <p>Le firewall UFW est configure pour autoriser SSH et WireGuard et bloquer le reste.</p>
              </div>

              <div class="section">
                  <h2>Securite</h2>
                  <ul>
                      <li>Mots de passe masques dans les logs</li>
                      <li>Permissions restrictives sur les fichiers de configuration</li>
                      <li>Firewall configure en mode strict</li>
                      <li>Service interne accessible uniquement via VPN</li>
                      <li>Utilisation d'ansible-vault recommandee pour les secrets</li>
                  </ul>
                  <p>Recommandations :</p>
                  <ul>
                      <li>Changez les mots de passe par defaut</li>
                      <li>Limitez l'acces SSH (cles SSH)</li>
                      <li>Mettez a jour le systeme regulierement</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>Acces aux services</h2>
                  <ul>
                      <li>WebUI : http://VOTRE_IP:5000</li>
                      <li>Prometheus : http://VOTRE_IP:9090</li>
                      <li>Grafana : http://VOTRE_IP:3000</li>
                      <li>Service interne Nginx : http://10.8.0.1:8080 (uniquement via VPN)</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>Depannage</h2>
                  <p>WireGuard ne demarre pas :</p>
                  <pre>sudo journalctl -u wg-quick@wg0 -n 50<br>sudo wg show</pre>
                  <p>Conteneurs Docker :</p>
                  <pre>docker logs &lt;nom_conteneur&gt;<br>docker ps -a</pre>
                  <p>Probleme de connexion VPN :</p>
                  <ul>
                      <li>Verifier que le port WireGuard est ouvert</li>
                      <li>Verifier la configuration client</li>
                      <li>Verifier les logs WireGuard</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>Supervision</h2>
                  <p>Grafana :</p>
                  <ul>
                      <li>Connexion via le port 3000</li>
                      <li>Ajouter Prometheus comme source de donnees (URL http://prometheus:9090)</li>
                      <li>Tableaux de bord : pairs actifs, trafic, etat serveur</li>
                  </ul>
                  <p>Metriques WireGuard exposees :</p>
                  <ul>
                      <li>wireguard_receive_bytes_total</li>
                      <li>wireguard_transmit_bytes_total</li>
                      <li>wireguard_peers</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>Tags disponibles</h2>
                  <pre>ansible-playbook deploy.yml --tags wireguard<br>ansible-playbook deploy.yml --tags docker<br>ansible-playbook add_user.yml --tags adduser</pre>
              </div>

              <div class="section">
                  <h2>Idempotence</h2>
                  <p>Tous les playbooks sont idempotents et peuvent etre executes plusieurs fois sans risque.</p>
              </div>

              <div class="section">
                  <h2>Auteur et licence</h2>
                  <p>Projet realise dans le cadre de la SAE502. Usage educatif uniquement.</p>
              </div>

              <div class="footer">
                  Acces reserve aux clients VPN autorises.
              </div>
          </div>
      </body>
      </html>
    dest: "{{ nginx_web_root }}/index.html"
    owner: root
    group: root
    mode: '0644'
  tags:
    - nginx
    - config

- name: Créer le répertoire pour la stack Nginx WebUI
  ansible.builtin.file:
    path: "{{ webui_storage_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - nginx
    - nginx-docker
    - config

- name: Créer le fichier docker-compose pour Nginx
  template:
    src: docker-compose-nginx.yml.j2
    dest: "{{ webui_storage_path }}/docker-compose-nginx.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - nginx
    - nginx-docker
    - config

- name: Créer la configuration Nginx
  template:
    src: nginx.conf.j2
    dest: "{{ webui_storage_path }}/nginx.conf"
    owner: root
    group: root
    mode: '0644'
  tags:
    - nginx
    - nginx-docker
    - config

- name: Afficher note sur conteneur Nginx interne
  ansible.builtin.debug:
    msg: "Le conteneur nginx-internal (port 8080) est démarré automatiquement par le rôle docker avec la stack unifiée."
  tags:
    - nginx
    - nginx-docker
    - info
