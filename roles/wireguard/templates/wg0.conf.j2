# Configuration WireGuard Serveur
# Généré automatiquement par Ansible

[Interface]
# Adresse IP du serveur sur le réseau VPN
Address = {{ wireguard_server_ip }}/24
# Port d'écoute
ListenPort = {{ wireguard_port }}
# Clé privée du serveur
PrivateKey = {{ wireguard_server_private_key }}

# Règles de forwarding (gestion des routes)
# Autoriser le forwarding depuis et vers l'interface WireGuard
# NAT pour le trafic sortant vers Internet
# Note: Les règles UFW gèrent l'accès aux services internes depuis le VPN (10.8.0.0/24)
# Utilisation de -I (insert) au lieu de -A (append) pour éviter les doublons
# Vérification de l'existence avant insertion pour idempotence
PostUp = iptables -t filter -C FORWARD -i {{ wireguard_interface }} -j ACCEPT 2>/dev/null || iptables -I FORWARD -i {{ wireguard_interface }} -j ACCEPT; iptables -t filter -C FORWARD -o {{ wireguard_interface }} -j ACCEPT 2>/dev/null || iptables -I FORWARD -o {{ wireguard_interface }} -j ACCEPT; iptables -t nat -C POSTROUTING -o {{ main_network_interface | default('eth0') }} -j MASQUERADE 2>/dev/null || iptables -t nat -I POSTROUTING -o {{ main_network_interface | default('eth0') }} -j MASQUERADE; sysctl -w net.ipv4.ip_forward=1
PostDown = iptables -t filter -D FORWARD -i {{ wireguard_interface }} -j ACCEPT 2>/dev/null || true; iptables -t filter -D FORWARD -o {{ wireguard_interface }} -j ACCEPT 2>/dev/null || true; iptables -t nat -D POSTROUTING -o {{ main_network_interface | default('eth0') }} -j MASQUERADE 2>/dev/null || true

# Pairs (clients) - Ajoutés dynamiquement par le rôle adduser
{% for peer in wireguard_peers | default([]) %}
[Peer]
# Client: {{ peer.name }}
PublicKey = {{ peer.public_key }}
AllowedIPs = {{ peer.allowed_ips }}
{% endfor %}
