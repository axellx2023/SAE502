---
# Rôle WireGuard - Installation et configuration du serveur VPN

- name: Définir l'IP effective pour l'Endpoint WireGuard
  ansible.builtin.set_fact:
    wireguard_effective_endpoint_ip: "{{ wireguard_server_public_ip | default(ansible_default_ipv4.address, true) }}"
  tags:
    - wireguard
    - config

- name: Afficher l'IP Endpoint utilisée
  ansible.builtin.debug:
    msg: "IP Endpoint WireGuard : {{ wireguard_effective_endpoint_ip }} ({{ 'IP publique configurée' if wireguard_server_public_ip | default('') != '' else 'IP locale détectée' }})"
  tags:
    - wireguard
    - config

- name: Installer les dépendances système
  apt:
    name:
      - wireguard
      - wireguard-tools
      - qrencode
      - iptables
      - curl
    state: present
    update_cache: yes
  tags:
    - wireguard
    - install

- name: Activer le forwarding IP
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    sysctl_set: yes
    reload: yes
  tags:
    - wireguard
    - config

- name: Détecter l'interface réseau principale
  shell: ip route | grep default | awk '{print $5}' | head -1
  register: main_interface
  changed_when: false
  tags:
    - wireguard
    - config

- name: Définir l'interface réseau principale
  set_fact:
    main_network_interface: "{{ main_interface.stdout | default('eth0') }}"
  tags:
    - wireguard
    - config

- name: Créer les répertoires nécessaires
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - "{{ wireguard_config_path }}"
    - "{{ wireguard_clients_path }}"
    - "{{ wireguard_qr_path }}"
  tags:
    - wireguard
    - config

- name: S'assurer que le dossier clients est en lecture seule pour Docker
  file:
    path: "{{ wireguard_clients_path }}"
    mode: '0755'
    owner: root
    group: root
  tags:
    - wireguard
    - config

- name: Générer la clé privée du serveur si elle n'existe pas
  command: wg genkey
  register: server_private_key
  changed_when: false
  when: wireguard_server_private_key == ""
  tags:
    - wireguard
    - keys

- name: Générer la clé publique du serveur si elle n'existe pas
  command: "echo '{{ server_private_key.stdout }}' | wg pubkey"
  register: server_public_key
  changed_when: false
  when: wireguard_server_private_key == ""
  tags:
    - wireguard
    - keys

- name: Définir les clés du serveur
  set_fact:
    wireguard_server_private_key: "{{ server_private_key.stdout }}"
    wireguard_server_public_key: "{{ server_public_key.stdout }}"
  when: wireguard_server_private_key == ""
  tags:
    - wireguard
    - keys

- name: Créer la configuration WireGuard du serveur
  ansible.builtin.template:
    src: wg0.conf.j2
    dest: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    owner: root
    group: root
    mode: '0600'
  notify: restart wireguard
  tags:
    - wireguard
    - config

- name: Normaliser automatiquement le format du fichier wg0.conf (Clé=Valeur → Clé = Valeur)
  ansible.builtin.replace:
    path: "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf"
    # Corrige toutes les lignes avec = collé (sans espaces) : Address= → Address = 
    # Exclut automatiquement les lignes qui ont déjà des espaces autour du =
    regexp: '^(\s*[A-Za-z][A-Za-z0-9]*)=(.+)$'
    replace: '\1 = \2'
  tags:
    - wireguard
    - config
    - validation

- name: Valider le format du fichier wg0.conf généré
  ansible.builtin.command: wg-quick strip "{{ wireguard_config_path }}/{{ wireguard_interface }}.conf" > /dev/null 2>&1
  register: wg0_template_validation
  changed_when: false
  failed_when: false
  tags:
    - wireguard
    - config
    - validation

- name: Échouer si le format est toujours invalide après normalisation
  ansible.builtin.fail:
    msg: |
      ❌ ERREUR : Le fichier wg0.conf a un format invalide après normalisation
      
      Fichier : {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
      
      Vérifiez le template : roles/wireguard/templates/wg0.conf.j2
      Toutes les lignes doivent utiliser le format : Clé = Valeur (avec espaces autour du =)
      
      Sortie wg-quick strip : {{ wg0_template_validation.stderr | default('Aucune sortie') }}
  when: wg0_template_validation.rc != 0
  tags:
    - wireguard
    - config
    - validation

- name: Activer et démarrer le service WireGuard
  systemd:
    name: "wg-quick@{{ wireguard_interface }}"
    enabled: yes
    state: started
    daemon_reload: yes
  tags:
    - wireguard
    - service

- name: Vérifier l'état de WireGuard
  command: wg show {{ wireguard_interface }}
  register: wg_status
  changed_when: false
  failed_when: false
  tags:
    - wireguard
    - check

- name: Afficher l'état de WireGuard
  debug:
    var: wg_status.stdout_lines
  when: wg_status.rc == 0
  tags:
    - wireguard
    - check
