---
# Rôle Docker - Installation de Docker et Docker Compose
- name: Installer les dépendances pour Docker
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes
  tags:
    - docker
    - install

- name: Ajouter la clé GPG de Docker
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present
  tags:
    - docker
    - install

- name: Ajouter le dépôt Docker
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
  tags:
    - docker
    - install

- name: Installer Docker
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: yes
  tags:
    - docker
    - install

- name: Démarrer et activer Docker
  systemd:
    name: docker
    enabled: yes
    state: started
  tags:
    - docker
    - service

- name: Installer Docker Compose standalone (version spécifique)
  get_url:
    url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-x86_64"
    dest: /usr/local/bin/docker-compose
    mode: '0755'
  tags:
    - docker
    - install

- name: Créer le répertoire pour la stack Docker unifiée
  file:
    path: "{{ docker_stack_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: Créer les sous-répertoires pour la stack
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - "{{ docker_stack_path }}/webapp"
    - "{{ docker_stack_path }}/webapp/templates"
    - "{{ docker_stack_path }}/nginx"
    - "{{ docker_stack_path }}/prometheus"
    - "{{ docker_stack_path }}/grafana/provisioning/datasources"
    - "{{ docker_stack_path }}/grafana/provisioning/dashboards"
    - "{{ docker_stack_path }}/grafana/dashboards"
  tags:
    - docker
    - config

- name: Créer les répertoires pour Docker (anciens chemins pour compatibilité)
  file:
    path: "{{ prometheus_data_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: Vérifier l'installation de Docker
  command: docker --version
  register: docker_version
  changed_when: false
  tags:
    - docker
    - check

- name: Vérifier l'installation de Docker Compose
  command: docker-compose --version
  register: docker_compose_version_check
  changed_when: false
  tags:
    - docker
    - check

- name: Afficher les versions installées
  debug:
    msg:
      - "Docker: {{ docker_version.stdout }}"
      - "Docker Compose: {{ docker_compose_version_check.stdout }}"
  tags:
    - docker
    - check

- name: Créer le fichier docker-compose.yml unifié
  template:
    src: docker-compose.yml.j2
    dest: "{{ docker_stack_path }}/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Créer le Dockerfile pour webapp
  copy:
    content: |
      FROM python:3.11-slim
      
      WORKDIR /app
      
      COPY requirements.txt .
      RUN pip install --no-cache-dir -r requirements.txt
      
      COPY app.py .
      COPY templates/ templates/
      
      EXPOSE 5000
      
      CMD ["python", "app.py"]
    dest: "{{ docker_stack_path }}/webapp/Dockerfile"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Créer le fichier requirements.txt pour webapp
  copy:
    content: |
      Flask==3.0.0
      qrcode[pil]==7.4.2
    dest: "{{ docker_stack_path }}/webapp/requirements.txt"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Créer l'application Flask webapp
  template:
    src: ../../webui/templates/app.py.j2
    dest: "{{ docker_stack_path }}/webapp/app.py"
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: Créer les templates HTML pour webapp
  copy:
    src: "{{ item.src }}"
    dest: "{{ docker_stack_path }}/webapp/templates/{{ item.dest }}"
    owner: root
    group: root
    mode: '0644'
    remote_src: false
  loop:
    - { src: '../../webui/templates/index.html.j2', dest: 'index.html' }
    - { src: '../../webui/templates/client.html.j2', dest: 'client.html' }
  tags:
    - docker
    - config

- name: Créer le répertoire pour le contenu web Nginx
  file:
    path: "{{ nginx_web_root }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: Créer la page d'accueil du service interne
  template:
    src: nginx/index.html.j2
    dest: "{{ nginx_web_root }}/index.html"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Créer la configuration Nginx
  template:
    src: ../../nginx/templates/nginx.conf.j2
    dest: "{{ docker_stack_path }}/nginx/nginx.conf"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Créer la configuration Prometheus
  template:
    src: ../../prometheus/templates/prometheus.yml.j2
    dest: "{{ docker_stack_path }}/prometheus/prometheus.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Créer la datasource Prometheus pour Grafana
  template:
    src: grafana/datasources.yml.j2
    dest: "{{ docker_stack_path }}/grafana/provisioning/datasources/prometheus.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Créer le provider de dashboards Grafana
  template:
    src: grafana/dashboards.yml.j2
    dest: "{{ docker_stack_path }}/grafana/provisioning/dashboards/wireguard.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Créer le dashboard WireGuard pour Grafana
  template:
    src: grafana/wireguard-dashboard.json.j2
    dest: "{{ docker_stack_path }}/grafana/dashboards/wireguard-dashboard.json"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Vérifier si le volume Grafana existe
  ansible.builtin.command: docker volume inspect grafana_data
  register: grafana_volume_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - deploy

- name: Avertir si Grafana doit être réinitialisé
  ansible.builtin.debug:
    msg: |
      ⚠️ NOTE : Si les credentials Grafana (admin/admin) ne fonctionnent pas,
      c'est que le volume persistant existe déjà avec d'anciens credentials.
      Pour réinitialiser : docker volume rm grafana_data
      Puis relancez le playbook pour recréer le volume avec les nouveaux credentials.
  when: grafana_volume_check.rc == 0
  tags:
    - docker
    - deploy

- name: Démarrer la stack Docker unifiée
  community.docker.docker_compose_v2:
    project_src: "{{ docker_stack_path }}"
    files:
      - docker-compose.yml
    state: present
    pull: always
  tags:
    - docker
    - deploy

- name: Vérifier l'état des conteneurs
  community.docker.docker_container_info:
    name: "{{ item }}"
  register: containers_status
  loop:
    - webapp-internal
    - "{{ nginx_container_name }}"
    - "{{ prometheus_container_name }}"
    - "{{ wireguard_exporter_container_name }}"
    - "{{ grafana_container_name }}"
  failed_when: false
  tags:
    - docker
    - check

- name: Attendre que WebUI soit prêt
  ansible.builtin.wait_for:
    port: 5000
    host: 127.0.0.1
    delay: 5
    timeout: 30
  tags:
    - docker
    - check

- name: Vérifier l'accessibilité du WebUI
  ansible.builtin.uri:
    url: http://127.0.0.1:5000
    method: GET
    status_code: [200, 302, 404]
  register: webui_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut du WebUI
  ansible.builtin.debug:
    msg: "WebUI accessible : {{ 'OUI' if webui_check.status | default(0) > 0 else 'NON' }} (code HTTP: {{ webui_check.status | default('N/A') }})"
  when: webui_check is defined
  tags:
    - docker
    - check

- name: Attendre que Grafana soit prêt
  ansible.builtin.wait_for:
    port: 3000
    host: 127.0.0.1
    delay: 10
    timeout: 60
  tags:
    - docker
    - check

- name: Vérifier l'accessibilité de Grafana
  ansible.builtin.uri:
    url: http://127.0.0.1:3000
    method: GET
    status_code: [200, 302, 401, 403]
  register: grafana_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut de Grafana
  ansible.builtin.debug:
    msg: "Grafana accessible : {{ 'OUI' if grafana_check.status | default(0) > 0 else 'NON' }} (code HTTP: {{ grafana_check.status | default('N/A') }})"
  when: grafana_check is defined
  tags:
    - docker
    - check

- name: Vérifier la connexion Prometheus vers wireguard-exporter
  ansible.builtin.command: docker exec {{ prometheus_container_name }} wget -qO- --timeout=5 http://wireguard-exporter:9586/metrics | head -5
  register: wireguard_exporter_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut de wireguard-exporter
  ansible.builtin.debug:
    msg: "{{ '✅ Supervision WireGuard OK (Prometheus peut atteindre wireguard-exporter)' if wireguard_exporter_check.rc == 0 else '❌ ERREUR WireGuard exporter : impossible d\'atteindre wireguard-exporter:9586 depuis Prometheus' }}"
  when: wireguard_exporter_check is defined
  tags:
    - docker
    - check
