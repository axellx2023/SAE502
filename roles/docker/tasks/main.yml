---
# RÃ´le Docker - Installation de Docker et Docker Compose
- name: Installer les dÃ©pendances pour Docker
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes
  tags:
    - docker
    - install

- name: Ajouter la clÃ© GPG de Docker
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present
  tags:
    - docker
    - install

- name: Ajouter le dÃ©pÃ´t Docker
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
  tags:
    - docker
    - install

- name: Installer Docker
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: yes
  tags:
    - docker
    - install

- name: DÃ©marrer et activer Docker
  systemd:
    name: docker
    enabled: yes
    state: started
  tags:
    - docker
    - service

- name: Installer Docker Compose standalone (version spÃ©cifique)
  get_url:
    url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-x86_64"
    dest: /usr/local/bin/docker-compose
    mode: '0755'
  tags:
    - docker
    - install

- name: CrÃ©er le rÃ©pertoire pour la stack Docker unifiÃ©e
  file:
    path: "{{ docker_stack_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: CrÃ©er les sous-rÃ©pertoires pour la stack
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - "{{ docker_stack_path }}/webapp"
    - "{{ docker_stack_path }}/webapp/templates"
    - "{{ docker_stack_path }}/nginx"
    - "{{ docker_stack_path }}/prometheus"
    - "{{ docker_stack_path }}/grafana/provisioning/datasources"
    - "{{ docker_stack_path }}/grafana/provisioning/dashboards"
    - "{{ docker_stack_path }}/grafana/dashboards"
  tags:
    - docker
    - config

- name: CrÃ©er les rÃ©pertoires pour Docker (anciens chemins pour compatibilitÃ©)
  file:
    path: "{{ prometheus_data_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: VÃ©rifier l'installation de Docker
  command: docker --version
  register: docker_version
  changed_when: false
  tags:
    - docker
    - check

- name: VÃ©rifier l'installation de Docker Compose
  command: docker-compose --version
  register: docker_compose_version_check
  changed_when: false
  tags:
    - docker
    - check

- name: Afficher les versions installÃ©es
  debug:
    msg:
      - "Docker: {{ docker_version.stdout }}"
      - "Docker Compose: {{ docker_compose_version_check.stdout }}"
  tags:
    - docker
    - check

- name: CrÃ©er le fichier docker-compose.yml unifiÃ©
  template:
    src: docker-compose.yml.j2
    dest: "{{ docker_stack_path }}/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: CrÃ©er le Dockerfile pour webapp
  copy:
    content: |
      FROM python:3.11-slim
      
      WORKDIR /app
      
      COPY requirements.txt .
      RUN pip install --no-cache-dir -r requirements.txt
      
      COPY app.py .
      COPY templates/ templates/
      
      EXPOSE 5000
      
      CMD ["python", "app.py"]
    dest: "{{ docker_stack_path }}/webapp/Dockerfile"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: CrÃ©er le fichier requirements.txt pour webapp
  copy:
    content: |
      Flask==3.0.0
      qrcode[pil]==7.4.2
    dest: "{{ docker_stack_path }}/webapp/requirements.txt"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: CrÃ©er l'application Flask webapp
  template:
    src: ../../webui/templates/app.py.j2
    dest: "{{ docker_stack_path }}/webapp/app.py"
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: CrÃ©er les templates HTML pour webapp
  copy:
    src: "{{ item.src }}"
    dest: "{{ docker_stack_path }}/webapp/templates/{{ item.dest }}"
    owner: root
    group: root
    mode: '0644'
    remote_src: false
  loop:
    - { src: '../../webui/templates/index.html.j2', dest: 'index.html' }
    - { src: '../../webui/templates/client.html.j2', dest: 'client.html' }
  register: templates_result
  tags:
    - docker
    - config

- name: Forcer la reconstruction du conteneur webapp si les templates ont changÃ©
  community.docker.docker_compose_v2:
    project_src: "{{ docker_stack_path }}"
    files:
      - docker-compose.yml
    state: present
    build: always
    pull: always
    recreate: always
  when: templates_result is defined and templates_result.changed
  tags:
    - docker
    - deploy

- name: CrÃ©er le rÃ©pertoire pour le contenu web Nginx
  file:
    path: "{{ nginx_web_root }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: CrÃ©er la page d'accueil du service interne
  template:
    src: nginx/index.html.j2
    dest: "{{ nginx_web_root }}/index.html"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: CrÃ©er la configuration Nginx
  template:
    src: ../../nginx/templates/nginx.conf.j2
    dest: "{{ docker_stack_path }}/nginx/nginx.conf"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: ArrÃªter la stack Docker si elle tourne (pour corriger les problÃ¨mes de montage)
  community.docker.docker_compose_v2:
    project_src: "{{ docker_stack_path }}"
    files:
      - docker-compose.yml
    state: stopped
  failed_when: false
  ignore_errors: yes
  tags:
    - docker
    - config
    - fix

- name: ArrÃªter le conteneur Prometheus s'il existe (pour corriger le montage)
  community.docker.docker_container:
    name: "{{ prometheus_container_name }}"
    state: stopped
  failed_when: false
  ignore_errors: yes
  tags:
    - docker
    - config
    - fix

- name: Supprimer le conteneur Prometheus s'il existe (pour corriger le montage)
  community.docker.docker_container:
    name: "{{ prometheus_container_name }}"
    state: absent
    force_absent: true
  failed_when: false
  ignore_errors: yes
  tags:
    - docker
    - config
    - fix

- name: S'assurer que le rÃ©pertoire prometheus existe
  file:
    path: "{{ docker_stack_path }}/prometheus"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: VÃ©rifier si prometheus.yml existe et son type
  stat:
    path: "{{ docker_stack_path }}/prometheus/prometheus.yml"
  register: prometheus_yml_stat
  tags:
    - docker
    - config

- name: Afficher le type dÃ©tectÃ© de prometheus.yml
  ansible.builtin.debug:
    msg: "Type dÃ©tectÃ© pour prometheus.yml : {{ 'rÃ©pertoire' if (prometheus_yml_stat.stat.exists and prometheus_yml_stat.stat.isdir) else ('fichier' if prometheus_yml_stat.stat.exists else 'inexistant') }}"
  when: prometheus_yml_stat.stat.exists
  tags:
    - docker
    - config

- name: Supprimer prometheus.yml si c'est un rÃ©pertoire (corriger le conflit automatiquement)
  ansible.builtin.command:
    cmd: rm -rf "{{ docker_stack_path }}/prometheus/prometheus.yml"
  when: prometheus_yml_stat.stat.exists and prometheus_yml_stat.stat.isdir
  tags:
    - docker
    - config

- name: Supprimer prometheus.yml s'il existe (fichier) pour forcer la recrÃ©ation
  ansible.builtin.file:
    path: "{{ docker_stack_path }}/prometheus/prometheus.yml"
    state: absent
  when: prometheus_yml_stat.stat.exists and not prometheus_yml_stat.stat.isdir
  tags:
    - docker
    - config

- name: CrÃ©er la configuration Prometheus
  template:
    src: ../../prometheus/templates/prometheus.yml.j2
    dest: "{{ docker_stack_path }}/prometheus/prometheus.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: VÃ©rifier que prometheus.yml est bien un fichier aprÃ¨s crÃ©ation
  ansible.builtin.stat:
    path: "{{ docker_stack_path }}/prometheus/prometheus.yml"
  register: prometheus_yml_final_check
  tags:
    - docker
    - config

- name: Corriger automatiquement si prometheus.yml n'est toujours pas un fichier
  ansible.builtin.command:
    cmd: |
      if [ -d "{{ docker_stack_path }}/prometheus/prometheus.yml" ]; then
        rm -rf "{{ docker_stack_path }}/prometheus/prometheus.yml"
        echo "RÃ©pertoire supprimÃ©, le fichier sera recrÃ©Ã©"
      fi
  when: not prometheus_yml_final_check.stat.exists or prometheus_yml_final_check.stat.isdir
  tags:
    - docker
    - config

- name: RecrÃ©er prometheus.yml si nÃ©cessaire aprÃ¨s correction
  template:
    src: ../../prometheus/templates/prometheus.yml.j2
    dest: "{{ docker_stack_path }}/prometheus/prometheus.yml"
    owner: root
    group: root
    mode: '0644'
  when: not prometheus_yml_final_check.stat.exists or prometheus_yml_final_check.stat.isdir
  tags:
    - docker
    - config

- name: VÃ©rification finale que prometheus.yml est un fichier
  ansible.builtin.stat:
    path: "{{ docker_stack_path }}/prometheus/prometheus.yml"
  register: prometheus_yml_verify
  tags:
    - docker
    - config

- name: Ã‰chouer si prometheus.yml n'est toujours pas un fichier aprÃ¨s correction
  ansible.builtin.fail:
    msg: |
      ERREUR CRITIQUE: Impossible de crÃ©er {{ docker_stack_path }}/prometheus/prometheus.yml comme fichier.
      Type dÃ©tectÃ©: {{ 'rÃ©pertoire' if prometheus_yml_verify.stat.isdir else 'inexistant' }}
      Veuillez vÃ©rifier les permissions et supprimer manuellement le rÃ©pertoire si nÃ©cessaire.
  when: not prometheus_yml_verify.stat.exists or prometheus_yml_verify.stat.isdir
  tags:
    - docker
    - config

- name: CrÃ©er la datasource Prometheus pour Grafana
  template:
    src: grafana/datasources.yml.j2
    dest: "{{ docker_stack_path }}/grafana/provisioning/datasources/prometheus.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: CrÃ©er le provider de dashboards Grafana
  template:
    src: grafana/dashboards.yml.j2
    dest: "{{ docker_stack_path }}/grafana/provisioning/dashboards/wireguard.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: CrÃ©er le dashboard WireGuard pour Grafana
  template:
    src: grafana/wireguard-dashboard.json.j2
    dest: "{{ docker_stack_path }}/grafana/dashboards/wireguard-dashboard.json"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: VÃ©rifier si le volume Grafana existe
  ansible.builtin.command: docker volume inspect grafana_data
  register: grafana_volume_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - deploy

- name: Avertir si Grafana doit Ãªtre rÃ©initialisÃ©
  ansible.builtin.debug:
    msg: |
      âš ï¸ NOTE : Si les credentials Grafana (admin/admin) ne fonctionnent pas,
      c'est que le volume persistant existe dÃ©jÃ  avec d'anciens credentials.
      Pour rÃ©initialiser : docker volume rm grafana_data
      Puis relancez le playbook pour recrÃ©er le volume avec les nouveaux credentials.
  when: grafana_volume_check.rc == 0
  tags:
    - docker
    - deploy

- name: DÃ©marrer la stack Docker unifiÃ©e
  community.docker.docker_compose_v2:
    project_src: "{{ docker_stack_path }}"
    files:
      - docker-compose.yml
    state: present
    pull: always
    build: always
  tags:
    - docker
    - deploy

- name: Attendre que wireguard-exporter soit prÃªt
  ansible.builtin.wait_for:
    port: 9586
    host: 127.0.0.1
    delay: 5
    timeout: 30
  tags:
    - docker
    - check

- name: VÃ©rifier l'Ã©tat des conteneurs
  community.docker.docker_container_info:
    name: "{{ item }}"
  register: containers_status
  loop:
    - webapp-internal
    - "{{ nginx_container_name }}"
    - "{{ prometheus_container_name }}"
    - "{{ wireguard_exporter_container_name }}"
    - "{{ grafana_container_name }}"
  failed_when: false
  tags:
    - docker
    - check

- name: Attendre que WebUI soit prÃªt
  ansible.builtin.wait_for:
    port: 5000
    host: 127.0.0.1
    delay: 5
    timeout: 30
  tags:
    - docker
    - check

- name: VÃ©rifier l'accessibilitÃ© du WebUI
  ansible.builtin.uri:
    url: http://127.0.0.1:5000
    method: GET
    status_code: [200, 302, 404]
  register: webui_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut du WebUI
  ansible.builtin.debug:
    msg: "WebUI accessible : {{ 'OUI' if webui_check.status | default(0) > 0 else 'NON' }} (code HTTP: {{ webui_check.status | default('N/A') }})"
  when: webui_check is defined
  tags:
    - docker
    - check

- name: Attendre que Grafana soit prÃªt
  ansible.builtin.wait_for:
    port: 3000
    host: 127.0.0.1
    delay: 10
    timeout: 60
  tags:
    - docker
    - check

- name: VÃ©rifier l'accessibilitÃ© de Grafana
  ansible.builtin.uri:
    url: http://127.0.0.1:3000
    method: GET
    status_code: [200, 302, 401, 403]
  register: grafana_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut de Grafana
  ansible.builtin.debug:
    msg: "Grafana accessible : {{ 'OUI' if grafana_check.status | default(0) > 0 else 'NON' }} (code HTTP: {{ grafana_check.status | default('N/A') }})"
  when: grafana_check is defined
  tags:
    - docker
    - check

- name: VÃ©rifier que wireguard-exporter est accessible
  ansible.builtin.uri:
    url: http://127.0.0.1:9586/metrics
    method: GET
    status_code: [200]
    timeout: 5
  register: wireguard_exporter_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut de wireguard-exporter
  ansible.builtin.debug:
    msg: "{{ 'âœ… WireGuard exporter accessible sur http://localhost:9586/metrics' if wireguard_exporter_check.status == 200 else 'âŒ ERREUR : WireGuard exporter non accessible (code: ' + wireguard_exporter_check.status | string + ')' }}"
  when: wireguard_exporter_check is defined
  tags:
    - docker
    - check

- name: VÃ©rifier les targets Prometheus
  ansible.builtin.uri:
    url: http://127.0.0.1:9090/api/v1/targets
    method: GET
    status_code: [200]
    timeout: 5
  register: prometheus_targets_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Parser les targets Prometheus
  ansible.builtin.set_fact:
    prometheus_targets_data: "{{ prometheus_targets_check.json.data | default({}) }}"
  when: prometheus_targets_check.status == 200
  tags:
    - docker
    - check

- name: Extraire le statut du target prometheus
  ansible.builtin.set_fact:
    prometheus_target_status: "{{ prometheus_targets_data.activeTargets | default([]) | selectattr('labels.job', 'equalto', 'prometheus') | map(attribute='health') | list | first | default('unknown') }}"
  when: prometheus_targets_data is defined
  tags:
    - docker
    - check

- name: Extraire le statut du target wireguard
  ansible.builtin.set_fact:
    wireguard_target_status: "{{ prometheus_targets_data.activeTargets | default([]) | selectattr('labels.job', 'equalto', 'wireguard') | map(attribute='health') | list | first | default('unknown') }}"
  when: prometheus_targets_data is defined
  tags:
    - docker
    - check

- name: Afficher le statut des targets Prometheus
  ansible.builtin.debug:
    msg:
      - "ğŸ“Š Targets Prometheus :"
      - "   â€¢ prometheus (localhost:9090) : {{ 'âœ… UP' if prometheus_target_status == 'up' else 'âŒ DOWN' }}"
      - "   â€¢ wireguard (localhost:9586) : {{ 'âœ… UP' if wireguard_target_status == 'up' else 'âŒ DOWN' }}"
  when: prometheus_targets_data is defined
  tags:
    - docker
    - check

- name: VÃ©rifier que Grafana est accessible et provisionnÃ©
  ansible.builtin.uri:
    url: http://127.0.0.1:3000/api/health
    method: GET
    status_code: [200]
    timeout: 5
  register: grafana_health_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: VÃ©rifier les datasources Grafana
  ansible.builtin.uri:
    url: http://127.0.0.1:3000/api/datasources
    method: GET
    status_code: [200]
    url_username: "{{ grafana_admin_user }}"
    url_password: "{{ grafana_admin_password }}"
    force_basic_auth: true
    timeout: 5
  register: grafana_datasources_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut Grafana
  ansible.builtin.debug:
    msg:
      - "ğŸ“ˆ Grafana :"
      - "   â€¢ Status : {{ 'âœ… OpÃ©rationnel' if grafana_health_check.status == 200 else 'âŒ Non accessible' }}"
      - "   â€¢ Datasources : {{ grafana_datasources_check.json | length if grafana_datasources_check.status == 200 else 'N/A' }} configurÃ©e(s)"
      - "   â€¢ Dashboard WireGuard : Auto-provisionnÃ© dans /var/lib/grafana/dashboards/"
  when: grafana_health_check is defined
  tags:
    - docker
    - check
