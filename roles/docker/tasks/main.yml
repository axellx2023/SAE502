---
# R√¥le Docker - Installation de Docker et Docker Compose
- name: Installer les d√©pendances pour Docker
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes
  tags:
    - docker
    - install

- name: Ajouter la cl√© GPG de Docker
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present
  tags:
    - docker
    - install

- name: Ajouter le d√©p√¥t Docker
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
  tags:
    - docker
    - install

- name: Installer Docker
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: yes
  tags:
    - docker
    - install

- name: D√©marrer et activer Docker
  systemd:
    name: docker
    enabled: yes
    state: started
  tags:
    - docker
    - service

- name: Installer Docker Compose standalone (version sp√©cifique)
  get_url:
    url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-x86_64"
    dest: /usr/local/bin/docker-compose
    mode: '0755'
  tags:
    - docker
    - install

- name: Cr√©er le r√©pertoire pour la stack Docker unifi√©e
  file:
    path: "{{ docker_stack_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: Cr√©er les sous-r√©pertoires pour la stack
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - "{{ docker_stack_path }}/webapp"
    - "{{ docker_stack_path }}/webapp/templates"
    - "{{ docker_stack_path }}/nginx"
    - "{{ docker_stack_path }}/prometheus"
    - "{{ docker_stack_path }}/grafana/provisioning/datasources"
    - "{{ docker_stack_path }}/grafana/provisioning/dashboards"
    - "{{ docker_stack_path }}/grafana/dashboards"
  tags:
    - docker
    - config

- name: Cr√©er les r√©pertoires pour Docker (anciens chemins pour compatibilit√©)
  file:
    path: "{{ prometheus_data_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: V√©rifier l'installation de Docker
  command: docker --version
  register: docker_version
  changed_when: false
  tags:
    - docker
    - check

- name: V√©rifier l'installation de Docker Compose
  command: docker-compose --version
  register: docker_compose_version_check
  changed_when: false
  tags:
    - docker
    - check

- name: Afficher les versions install√©es
  debug:
    msg:
      - "Docker: {{ docker_version.stdout }}"
      - "Docker Compose: {{ docker_compose_version_check.stdout }}"
  tags:
    - docker
    - check

- name: Cr√©er le fichier docker-compose.yml unifi√©
  template:
    src: docker-compose.yml.j2
    dest: "{{ docker_stack_path }}/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Cr√©er le Dockerfile pour webapp
  copy:
    content: |
      FROM python:3.11-slim
      
      WORKDIR /app
      
      COPY requirements.txt .
      RUN pip install --no-cache-dir -r requirements.txt
      
      COPY app.py .
      COPY templates/ templates/
      
      EXPOSE 5000
      
      CMD ["python", "app.py"]
    dest: "{{ docker_stack_path }}/webapp/Dockerfile"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Cr√©er le fichier requirements.txt pour webapp
  copy:
    content: |
      Flask==3.0.0
      qrcode[pil]==7.4.2
    dest: "{{ docker_stack_path }}/webapp/requirements.txt"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Cr√©er l'application Flask webapp
  template:
    src: ../../webui/templates/app.py.j2
    dest: "{{ docker_stack_path }}/webapp/app.py"
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: Cr√©er les templates HTML pour webapp
  copy:
    src: "{{ item.src }}"
    dest: "{{ docker_stack_path }}/webapp/templates/{{ item.dest }}"
    owner: root
    group: root
    mode: '0644'
    remote_src: false
  loop:
    - { src: '../../webui/templates/index.html.j2', dest: 'index.html' }
    - { src: '../../webui/templates/client.html.j2', dest: 'client.html' }
  tags:
    - docker
    - config

- name: Cr√©er le r√©pertoire pour le contenu web Nginx
  file:
    path: "{{ nginx_web_root }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - docker
    - config

- name: Cr√©er la page d'accueil du service interne
  template:
    src: nginx/index.html.j2
    dest: "{{ nginx_web_root }}/index.html"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Cr√©er la configuration Nginx
  template:
    src: ../../nginx/templates/nginx.conf.j2
    dest: "{{ docker_stack_path }}/nginx/nginx.conf"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Cr√©er la configuration Prometheus
  template:
    src: ../../prometheus/templates/prometheus.yml.j2
    dest: "{{ docker_stack_path }}/prometheus/prometheus.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Cr√©er la datasource Prometheus pour Grafana
  template:
    src: grafana/datasources.yml.j2
    dest: "{{ docker_stack_path }}/grafana/provisioning/datasources/prometheus.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Cr√©er le provider de dashboards Grafana
  template:
    src: grafana/dashboards.yml.j2
    dest: "{{ docker_stack_path }}/grafana/provisioning/dashboards/wireguard.yml"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: Cr√©er le dashboard WireGuard pour Grafana
  template:
    src: grafana/wireguard-dashboard.json.j2
    dest: "{{ docker_stack_path }}/grafana/dashboards/wireguard-dashboard.json"
    owner: root
    group: root
    mode: '0644'
  tags:
    - docker
    - config

- name: V√©rifier si le volume Grafana existe
  ansible.builtin.command: docker volume inspect grafana_data
  register: grafana_volume_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - deploy

- name: Avertir si Grafana doit √™tre r√©initialis√©
  ansible.builtin.debug:
    msg: |
      ‚ö†Ô∏è NOTE : Si les credentials Grafana (admin/admin) ne fonctionnent pas,
      c'est que le volume persistant existe d√©j√† avec d'anciens credentials.
      Pour r√©initialiser : docker volume rm grafana_data
      Puis relancez le playbook pour recr√©er le volume avec les nouveaux credentials.
  when: grafana_volume_check.rc == 0
  tags:
    - docker
    - deploy

- name: D√©marrer la stack Docker unifi√©e
  community.docker.docker_compose_v2:
    project_src: "{{ docker_stack_path }}"
    files:
      - docker-compose.yml
    state: present
    pull: always
  tags:
    - docker
    - deploy

- name: Attendre que wireguard-exporter soit pr√™t
  ansible.builtin.wait_for:
    port: 9586
    host: 127.0.0.1
    delay: 5
    timeout: 30
  tags:
    - docker
    - check

- name: V√©rifier l'√©tat des conteneurs
  community.docker.docker_container_info:
    name: "{{ item }}"
  register: containers_status
  loop:
    - webapp-internal
    - "{{ nginx_container_name }}"
    - "{{ prometheus_container_name }}"
    - "{{ wireguard_exporter_container_name }}"
    - "{{ grafana_container_name }}"
  failed_when: false
  tags:
    - docker
    - check

- name: Attendre que WebUI soit pr√™t
  ansible.builtin.wait_for:
    port: 5000
    host: 127.0.0.1
    delay: 5
    timeout: 30
  tags:
    - docker
    - check

- name: V√©rifier l'accessibilit√© du WebUI
  ansible.builtin.uri:
    url: http://127.0.0.1:5000
    method: GET
    status_code: [200, 302, 404]
  register: webui_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut du WebUI
  ansible.builtin.debug:
    msg: "WebUI accessible : {{ 'OUI' if webui_check.status | default(0) > 0 else 'NON' }} (code HTTP: {{ webui_check.status | default('N/A') }})"
  when: webui_check is defined
  tags:
    - docker
    - check

- name: Attendre que Grafana soit pr√™t
  ansible.builtin.wait_for:
    port: 3000
    host: 127.0.0.1
    delay: 10
    timeout: 60
  tags:
    - docker
    - check

- name: V√©rifier l'accessibilit√© de Grafana
  ansible.builtin.uri:
    url: http://127.0.0.1:3000
    method: GET
    status_code: [200, 302, 401, 403]
  register: grafana_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut de Grafana
  ansible.builtin.debug:
    msg: "Grafana accessible : {{ 'OUI' if grafana_check.status | default(0) > 0 else 'NON' }} (code HTTP: {{ grafana_check.status | default('N/A') }})"
  when: grafana_check is defined
  tags:
    - docker
    - check

- name: V√©rifier que wireguard-exporter est accessible
  ansible.builtin.uri:
    url: http://127.0.0.1:9586/metrics
    method: GET
    status_code: [200]
    timeout: 5
  register: wireguard_exporter_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut de wireguard-exporter
  ansible.builtin.debug:
    msg: "{{ '‚úÖ WireGuard exporter accessible sur http://localhost:9586/metrics' if wireguard_exporter_check.status == 200 else '‚ùå ERREUR : WireGuard exporter non accessible (code: ' + wireguard_exporter_check.status | string + ')' }}"
  when: wireguard_exporter_check is defined
  tags:
    - docker
    - check

- name: V√©rifier les targets Prometheus
  ansible.builtin.uri:
    url: http://127.0.0.1:9090/api/v1/targets
    method: GET
    status_code: [200]
    timeout: 5
  register: prometheus_targets_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Parser les targets Prometheus
  ansible.builtin.set_fact:
    prometheus_targets_json: "{{ prometheus_targets_check.json }}"
  when: prometheus_targets_check.status == 200
  tags:
    - docker
    - check

- name: Afficher le statut des targets Prometheus
  ansible.builtin.debug:
    msg:
      - "üìä Targets Prometheus :"
      - "   ‚Ä¢ prometheus (localhost:9090) : {{ 'UP' if prometheus_targets_json.activeTargets | selectattr('job', 'equalto', 'prometheus') | map(attribute='health') | list | first == 'up' else 'DOWN' }}"
      - "   ‚Ä¢ wireguard (localhost:9586) : {{ 'UP' if prometheus_targets_json.activeTargets | selectattr('job', 'equalto', 'wireguard') | map(attribute='health') | list | first == 'up' else 'DOWN' }}"
  when: prometheus_targets_json is defined
  tags:
    - docker
    - check

- name: V√©rifier que Grafana est accessible et provisionn√©
  ansible.builtin.uri:
    url: http://127.0.0.1:3000/api/health
    method: GET
    status_code: [200]
    timeout: 5
  register: grafana_health_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: V√©rifier les datasources Grafana
  ansible.builtin.uri:
    url: http://127.0.0.1:3000/api/datasources
    method: GET
    status_code: [200]
    url_username: "{{ grafana_admin_user }}"
    url_password: "{{ grafana_admin_password }}"
    force_basic_auth: true
    timeout: 5
  register: grafana_datasources_check
  changed_when: false
  failed_when: false
  tags:
    - docker
    - check

- name: Afficher le statut Grafana
  ansible.builtin.debug:
    msg:
      - "üìà Grafana :"
      - "   ‚Ä¢ Status : {{ '‚úÖ Op√©rationnel' if grafana_health_check.status == 200 else '‚ùå Non accessible' }}"
      - "   ‚Ä¢ Datasources : {{ grafana_datasources_check.json | length if grafana_datasources_check.status == 200 else 'N/A' }} configur√©e(s)"
      - "   ‚Ä¢ Dashboard WireGuard : Auto-provisionn√© dans /var/lib/grafana/dashboards/"
  when: grafana_health_check is defined
  tags:
    - docker
    - check
