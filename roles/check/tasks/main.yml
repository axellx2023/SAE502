---
# Rôle Check - Vérifications de l'état du serveur VPN
- name: Vérifier l'état du service WireGuard
  systemd:
    name: "wg-quick@{{ wireguard_interface }}"
  register: wireguard_service
  tags:
    - check
    - wireguard

- name: Afficher l'état du service WireGuard
  debug:
    msg:
      - "Service WireGuard: {{ 'Actif' if wireguard_service.status.ActiveState == 'active' else 'Inactif' }}"
      - "État: {{ wireguard_service.status.ActiveState }}"
  tags:
    - check
    - wireguard

- name: Récupérer les informations WireGuard
  command: wg show {{ wireguard_interface }}
  register: wg_show
  changed_when: false
  failed_when: false
  tags:
    - check
    - wireguard

- name: Afficher les pairs WireGuard connectés
  debug:
    var: wg_show.stdout_lines
  when: wg_show.rc == 0
  tags:
    - check
    - wireguard

- name: Compter les pairs actifs
  set_fact:
    active_peers_count: "{{ wg_show.stdout | regex_findall('peer:') | length }}"
  when: wg_show.rc == 0
  tags:
    - check
    - wireguard

- name: Afficher le nombre de pairs actifs
  debug:
    msg: "Nombre de pairs WireGuard actifs: {{ active_peers_count | default(0) }}"
  tags:
    - check
    - wireguard

- name: Vérifier l'uptime du système
  command: uptime
  register: system_uptime
  changed_when: false
  tags:
    - check
    - system

- name: Afficher l'uptime
  debug:
    var: system_uptime.stdout
  tags:
    - check
    - system

- name: Vérifier l'état des conteneurs Docker
  docker_container_info:
    name: "{{ item }}"
  register: docker_containers
  loop:
    - "{{ nginx_container_name }}"
    - "{{ webui_container_name }}"
    - "{{ prometheus_container_name }}"
    - "{{ wireguard_exporter_container_name }}"
    - "{{ grafana_container_name }}"
  failed_when: false
  tags:
    - check
    - docker

- name: Afficher l'état des conteneurs Docker
  debug:
    msg: "{{ item.name }}: {{ 'Actif' if item.container.State.Running else 'Arrêté' }} ({{ item.container.State.Status }})"
  loop: "{{ docker_containers.results }}"
  when: item.container is defined
  tags:
    - check
    - docker

- name: Vérifier l'accessibilité de Prometheus
  uri:
    url: "http://localhost:{{ prometheus_port }}/api/v1/status/config"
    method: GET
    status_code: 200
  register: prometheus_check
  changed_when: false
  failed_when: false
  tags:
    - check
    - prometheus

- name: Afficher l'état de Prometheus
  debug:
    msg: "Prometheus: {{ 'Accessible' if prometheus_check.status == 200 else 'Inaccessible' }}"
  tags:
    - check
    - prometheus

- name: Vérifier l'accessibilité de Grafana
  uri:
    url: "http://localhost:{{ grafana_port }}/api/health"
    method: GET
    status_code: 200
  register: grafana_check
  changed_when: false
  failed_when: false
  tags:
    - check
    - grafana

- name: Afficher l'état de Grafana
  debug:
    msg: "Grafana: {{ 'Accessible' if grafana_check.status == 200 else 'Inaccessible' }}"
  tags:
    - check
    - grafana

- name: Vérifier l'accessibilité de WebUI
  uri:
    url: "http://localhost:{{ webui_port }}/"
    method: GET
    status_code: 200
  register: webui_check
  changed_when: false
  failed_when: false
  tags:
    - check
    - webui

- name: Afficher l'état de WebUI
  debug:
    msg: "WebUI: {{ 'Accessible' if webui_check.status == 200 else 'Inaccessible' }}"
  tags:
    - check
    - webui

- name: Vérifier les métriques WireGuard Exporter
  uri:
    url: "http://localhost:{{ wireguard_exporter_port }}/metrics"
    method: GET
    status_code: 200
  register: exporter_check
  changed_when: false
  failed_when: false
  tags:
    - check
    - exporter

- name: Afficher l'état du WireGuard Exporter
  debug:
    msg: "WireGuard Exporter: {{ 'Accessible' if exporter_check.status == 200 else 'Inaccessible' }}"
  tags:
    - check
    - exporter

- name: Résumé des vérifications
  debug:
    msg:
      - "=== Résumé des vérifications ==="
      - "WireGuard: {{ '✅ Actif' if wireguard_service.status.ActiveState == 'active' else '❌ Inactif' }}"
      - "Pairs actifs: {{ active_peers_count | default(0) }}"
      - "Prometheus: {{ '✅ OK' if prometheus_check.status == 200 else '❌ KO' }}"
      - "Grafana: {{ '✅ OK' if grafana_check.status == 200 else '❌ KO' }}"
      - "WebUI: {{ '✅ OK' if webui_check.status == 200 else '❌ KO' }}"
      - "WireGuard Exporter: {{ '✅ OK' if exporter_check.status == 200 else '❌ KO' }}"
  tags:
    - check
    - summary
