---
# Playbook interactif pour ajouter un utilisateur VPN WireGuard
# Usage: ansible-playbook add_user.yml
# Le playbook demande interactivement le nom d'utilisateur et le rÃ´le
- name: Ajout interactif d'un utilisateur VPN WireGuard
  hosts: vpn_servers
  become: yes
  gather_facts: yes

  vars_prompt:
    - name: client_name
      prompt: "Nom du client VPN (espaces â†’ tirets automatiquement) [default: user1]"
      private: no
      default: "user1"

    - name: user_role
      prompt: "RÃ´le du client - restricted (VPN seul), allowed (VPN + services internes), admin (accÃ¨s complet) [default: allowed]"
      private: no
      default: "allowed"

  pre_tasks:
    - name: DÃ©finir l'IP effective pour l'Endpoint WireGuard (variable globale)
      ansible.builtin.set_fact:
        wireguard_effective_endpoint_ip: "{{ wireguard_server_public_ip | default(ansible_default_ipv4.address, true) }}"
      tags:
        - adduser
        - config

    - name: Normaliser le nom du client (remplacer espaces par tirets)
      ansible.builtin.set_fact:
        client_name: "{{ client_name | replace(' ', '-') | lower }}"
      tags:
        - adduser
        - config

    - name: Normaliser le rÃ´le (minuscule + trim)
      ansible.builtin.set_fact:
        user_role: "{{ user_role | lower | trim }}"
      tags:
        - adduser
        - config

    - name: VÃ©rifier que le nom du client est valide
      assert:
        that:
          - client_name | length > 0
          - client_name | regex_search('^[a-zA-Z0-9_-]+$')
        fail_msg: "Le nom du client doit contenir uniquement des lettres, chiffres, tirets et underscores"
        success_msg: "Nom du client valide (normalisÃ© : {{ client_name }})"

    - name: VÃ©rifier que le rÃ´le est valide
      assert:
        that:
          - user_role in ['restricted', 'allowed', 'admin']
        fail_msg: "Le rÃ´le doit Ãªtre 'restricted', 'allowed' ou 'admin'"
        success_msg: "RÃ´le valide : {{ user_role }}"

    - name: VÃ©rifier que le client n'existe pas dÃ©jÃ 
      stat:
        path: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
      register: client_exists

    - name: ArrÃªter si le client existe dÃ©jÃ 
      ansible.builtin.fail:
        msg: |
          âŒ Le client '{{ client_name }}' existe dÃ©jÃ .
          
          Pour recrÃ©er ce client :
          1. Supprimez le fichier : {{ wireguard_clients_path }}/{{ client_name }}.conf
          2. Supprimez le QR code : {{ wireguard_qr_path }}/{{ client_name }}.png
          3. Supprimez le bloc [Peer] correspondant dans {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
          4. Rechargez WireGuard : wg syncconf {{ wireguard_interface }} {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
          5. Relancez ce playbook
          
          OU choisissez un autre nom de client.
      when: client_exists.stat.exists

    - name: Extraire le prÃ©fixe rÃ©seau WireGuard (3 premiers octets) - mÃ©thode robuste
      ansible.builtin.set_fact:
        # Utiliser wireguard_server_ip (10.8.0.1) et extraire les 3 premiers octets
        # C'est plus fiable que d'extraire depuis wireguard_network
        wireguard_network_prefix: "{{ wireguard_server_ip | regex_replace('\\.[0-9]+$', '') }}"
      tags:
        - adduser
        - config

    - name: VÃ©rifier que le prÃ©fixe rÃ©seau est correct (debug)
      ansible.builtin.debug:
        msg: "PrÃ©fixe rÃ©seau extrait : {{ wireguard_network_prefix }} (attendu: 10.8.0)"
      tags:
        - adduser
        - config

    - name: Extraire les IPs utilisÃ©es depuis wg0.conf
      ansible.builtin.shell: |
        grep -E "AllowedIPs = {{ wireguard_network_prefix | regex_escape() }}\.[0-9]+/32" {{ wireguard_config_path }}/{{ wireguard_interface }}.conf 2>/dev/null | \
        sed 's/.*AllowedIPs = {{ wireguard_network_prefix | regex_escape() }}\.\([0-9]*\)\/32.*/\1/' | \
        sort -nu
      register: used_ips_wg0
      changed_when: false
      failed_when: false

    - name: Extraire les IPs utilisÃ©es depuis les fichiers clients .conf
      ansible.builtin.shell: |
        grep -hE "^Address = {{ wireguard_network_prefix | regex_escape() }}\.[0-9]+/32" {{ wireguard_clients_path }}/*.conf 2>/dev/null | \
        sed 's/.*Address = {{ wireguard_network_prefix | regex_escape() }}\.\([0-9]*\)\/32.*/\1/' | \
        sort -nu
      register: used_ips_clients
      changed_when: false
      failed_when: false

    - name: Fusionner toutes les IPs utilisÃ©es
      ansible.builtin.set_fact:
        all_used_ips: "{{ (used_ips_wg0.stdout_lines | default([])) + (used_ips_clients.stdout_lines | default([])) | unique | map('int') | list | sort }}"
      tags:
        - adduser
        - config

    - name: Calculer le prochain IP disponible
      ansible.builtin.set_fact:
        next_ip_num: "{{ range(2, 255) | reject('in', all_used_ips | default([])) | first | default(254) }}"
      tags:
        - adduser
        - config

    - name: VÃ©rifier que l'IP calculÃ©e est dans la plage valide
      ansible.builtin.assert:
        that:
          - next_ip_num | int >= 2
          - next_ip_num | int <= 254
          - next_ip_num | int not in (all_used_ips | default([]))
        fail_msg: "Impossible de trouver une IP disponible dans le rÃ©seau {{ wireguard_network }} (253 clients maximum). IPs dÃ©jÃ  utilisÃ©es : {{ all_used_ips | default([]) | join(', ') }}"
        success_msg: "IP disponible trouvÃ©e : {{ wireguard_network_prefix }}.{{ next_ip_num }} (vÃ©rifiez que le prÃ©fixe est bien 10.8.0)"
      tags:
        - adduser
        - config

    - name: DÃ©finir l'IP du client
      ansible.builtin.set_fact:
        user_ip: "{{ wireguard_network_prefix }}.{{ next_ip_num }}"
      tags:
        - adduser
        - config

    - name: VÃ©rifier que l'IP gÃ©nÃ©rÃ©e est valide (format 10.8.0.X)
      ansible.builtin.assert:
        that:
          - user_ip | regex_search('^10\\.8\\.0\\.[0-9]+$')
          - user_ip != "10.8.0.0"
          - user_ip != "10.8.0.1"
        fail_msg: |
          âŒ ERREUR CRITIQUE : IP invalide gÃ©nÃ©rÃ©e : {{ user_ip }}
          Le prÃ©fixe rÃ©seau extrait est : {{ wireguard_network_prefix }}
          L'IP doit Ãªtre au format 10.8.0.X (oÃ¹ X est entre 2 et 254)
          VÃ©rifiez la variable wireguard_server_ip dans group_vars/vpn_servers.yml
        success_msg: "âœ… IP valide gÃ©nÃ©rÃ©e : {{ user_ip }}"
      tags:
        - adduser
        - config

  roles:
    - role: adduser
      tags: adduser

  post_tasks:
    - name: Afficher un rÃ©sumÃ© de la crÃ©ation
      debug:
        msg:
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… Client VPN crÃ©Ã© avec succÃ¨s !"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ‘¤ Nom du client : {{ client_name }}"
          - "ğŸŒ IP VPN attribuÃ©e  : {{ user_ip }}"
          - "ğŸ” RÃ´le : {{ user_role }}"
          - ""
          - "ğŸ“ Fichiers crÃ©Ã©s :"
          - "   â€¢ Configuration : {{ wireguard_clients_path }}/{{ client_name }}.conf"
          - "   â€¢ QR Code       : {{ wireguard_qr_path }}/{{ client_name }}.png"
          - ""
          - "ğŸ“± Pour utiliser le VPN :"
          - "   1. TÃ©lÃ©chargez le fichier .conf ou scannez le QR code"
          - "   2. Importez-le dans votre client WireGuard"
          - "   3. Activez la connexion VPN"
          - ""
          - "ğŸ”— AccÃ¨s aux fichiers :"
          - "   â€¢ WebUI : http://{{ ansible_default_ipv4.address }}:{{ webui_port }}"
          - ""
          - "ğŸŒ Endpoint WireGuard : {{ wireguard_effective_endpoint_ip | default('DÃ©tection...') }}:{{ wireguard_port }}"
          - "   ({{ 'IP publique configurÃ©e' if wireguard_server_public_ip | default('') != '' else 'IP locale dÃ©tectÃ©e automatiquement' }})"
          - ""
          - "ğŸŒ AccÃ¨s selon le rÃ´le :"
          - "   â€¢ restricted : VPN uniquement (aucun service)"
          - "   â€¢ allowed : VPN + services internes (Nginx, Grafana)"
          - "   â€¢ admin : AccÃ¨s complet (tous les services)"
          - ""
          - "ğŸ“Š Services disponibles :"
          - "   â€¢ Nginx interne : http://{{ wireguard_server_ip }}:{{ nginx_port }}"
          - "   â€¢ Grafana : http://{{ wireguard_server_ip }}:{{ grafana_port }}"
          - "   â€¢ Prometheus : http://{{ wireguard_server_ip }}:{{ prometheus_port }} (admin uniquement)"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
