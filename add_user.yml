---
# Playbook interactif pour ajouter un utilisateur VPN WireGuard
# Usage: ansible-playbook add_user.yml
# Le playbook demande interactivement le nom d'utilisateur et le rÃ´le
- name: Ajout interactif d'un utilisateur VPN WireGuard
  hosts: vpn_servers
  become: yes
  gather_facts: yes

  vars_prompt:
    - name: client_name
      prompt: "Nom du client VPN (espaces â†’ tirets automatiquement) [default: user1]"
      private: no
      default: "user1"

    - name: user_role
      prompt: "RÃ´le du client - restricted (VPN seul), allowed (VPN + services internes), admin (accÃ¨s complet) [default: allowed]"
      private: no
      default: "allowed"

  pre_tasks:
    - name: Normaliser le nom du client (remplacer espaces par tirets)
      set_fact:
        client_name: "{{ client_name | replace(' ', '-') | lower }}"
      tags:
        - adduser
        - config

    - name: VÃ©rifier que le nom du client est valide
      assert:
        that:
          - client_name | length > 0
          - client_name | regex_search('^[a-zA-Z0-9_-]+$')
        fail_msg: "Le nom du client doit contenir uniquement des lettres, chiffres, tirets et underscores"
        success_msg: "Nom du client valide (normalisÃ© : {{ client_name }})"

    - name: VÃ©rifier que le rÃ´le est valide
      assert:
        that:
          - user_role in ['restricted', 'allowed', 'admin']
        fail_msg: "Le rÃ´le doit Ãªtre 'restricted', 'allowed' ou 'admin'"
        success_msg: "RÃ´le valide : {{ user_role }}"

    - name: VÃ©rifier que le client n'existe pas dÃ©jÃ 
      stat:
        path: "{{ wireguard_clients_path }}/{{ client_name }}.conf"
      register: client_exists

    - name: ArrÃªter si le client existe dÃ©jÃ 
      fail:
        msg: "âŒ Le client '{{ client_name }}' existe dÃ©jÃ . Choisissez un autre nom."
      when: client_exists.stat.exists

    - name: Trouver automatiquement l'IP suivante disponible
      shell: |
        # Extraire toutes les IPs utilisÃ©es depuis wg0.conf
        grep -E "AllowedIPs = 10\.10\.10\.[0-9]+/32" {{ wireguard_config_path }}/{{ wireguard_interface }}.conf | \
        sed 's/.*AllowedIPs = 10\.10\.10\.\([0-9]*\)\/32.*/\1/' | \
        sort -n
      register: used_ips
      changed_when: false
      failed_when: false

    - name: Calculer l'IP suivante disponible
      set_fact:
        next_ip_num: "{{ (used_ips.stdout_lines | map('int') | list | max | default(1)) + 1 }}"
      when: used_ips.stdout_lines | length > 0

    - name: DÃ©finir l'IP par dÃ©faut si aucun client n'existe
      set_fact:
        next_ip_num: 2
      when: used_ips.stdout_lines | length == 0

    - name: VÃ©rifier que l'IP calculÃ©e est dans la plage valide
      assert:
        that:
          - next_ip_num | int >= 2
          - next_ip_num | int <= 254
        fail_msg: "Impossible de trouver une IP disponible dans le rÃ©seau 10.10.10.0/24"
        success_msg: "IP disponible trouvÃ©e : 10.10.10.{{ next_ip_num }}"

    - name: DÃ©finir l'IP du client
      set_fact:
        user_ip: "10.10.10.{{ next_ip_num }}"

  roles:
    - role: adduser
      tags: adduser

  post_tasks:
    - name: Afficher un rÃ©sumÃ© de la crÃ©ation
      debug:
        msg:
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… Client VPN crÃ©Ã© avec succÃ¨s !"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ‘¤ Nom du client : {{ client_name }}"
          - "ğŸŒ IP VPN attribuÃ©e  : {{ user_ip }}"
          - "ğŸ” RÃ´le : {{ user_role }}"
          - ""
          - "ğŸ“ Fichiers crÃ©Ã©s :"
          - "   â€¢ Configuration : {{ wireguard_clients_path }}/{{ client_name }}.conf"
          - "   â€¢ QR Code       : {{ wireguard_qr_path }}/{{ client_name }}.png"
          - ""
          - "ğŸ“± Pour utiliser le VPN :"
          - "   1. TÃ©lÃ©chargez le fichier .conf ou scannez le QR code"
          - "   2. Importez-le dans votre client WireGuard"
          - "   3. Activez la connexion VPN"
          - ""
          - "ğŸ”— AccÃ¨s aux fichiers :"
          - "   â€¢ WebUI : http://{{ ansible_default_ipv4.address }}:{{ webui_port }}"
          - ""
          - "ğŸŒ AccÃ¨s selon le rÃ´le :"
          - "   â€¢ restricted : VPN uniquement (aucun service)"
          - "   â€¢ allowed : VPN + services internes (Nginx, Grafana)"
          - "   â€¢ admin : AccÃ¨s complet (tous les services)"
          - ""
          - "ğŸ“Š Services disponibles :"
          - "   â€¢ Nginx interne : http://{{ wireguard_server_ip }}:{{ nginx_port }}"
          - "   â€¢ Grafana : http://{{ wireguard_server_ip }}:{{ grafana_port }}"
          - "   â€¢ Prometheus : http://{{ wireguard_server_ip }}:{{ prometheus_port }} (admin uniquement)"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
