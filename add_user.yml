---
# Playbook interactif pour ajouter un utilisateur VPN WireGuard
# Usage: ansible-playbook add_user.yml
# Le playbook demande interactivement le nom d'utilisateur et l'IP VPN
- name: Ajout interactif d'un utilisateur VPN WireGuard
  hosts: vpn_servers
  become: yes
  gather_facts: yes

  vars_prompt:
    - name: username
      prompt: "Nom d'utilisateur VPN"
      private: no
      default: "user1"
      help: |
        Entrez le nom de l'utilisateur VPN Ã  crÃ©er.
        Ce nom sera utilisÃ© pour le fichier de configuration (.conf) et le QR code.
        Exemples : john, alice, smartphone, laptop

    - name: user_ip
      prompt: "IP VPN de l'utilisateur (dans le rÃ©seau 10.8.0.0/24)"
      private: no
      default: "10.8.0.10"
      help: |
        Entrez l'adresse IP que l'utilisateur aura dans le rÃ©seau VPN.
        Doit Ãªtre dans le rÃ©seau 10.8.0.0/24 et diffÃ©rente de 10.8.0.1 (serveur).
        Exemples : 10.8.0.10, 10.8.0.20, 10.8.0.100
        âš ï¸ Chaque utilisateur doit avoir une IP unique !

  pre_tasks:
    - name: Valider le format de l'IP
      assert:
        that:
          - user_ip | regex_search('^10\\.8\\.0\\.([1-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-4])$')
        fail_msg: "L'IP doit Ãªtre dans le rÃ©seau 10.8.0.0/24 et diffÃ©rente de 10.8.0.1"
        success_msg: "Format d'IP valide"

    - name: VÃ©rifier que l'IP n'est pas celle du serveur
      assert:
        that:
          - user_ip != wireguard_server_ip
        fail_msg: "L'IP {{ user_ip }} est rÃ©servÃ©e au serveur ({{ wireguard_server_ip }})"
        success_msg: "IP diffÃ©rente de celle du serveur"

    - name: VÃ©rifier que l'IP n'est pas dÃ©jÃ  utilisÃ©e
      command: grep -q "{{ user_ip }}" {{ wireguard_config_path }}/{{ wireguard_interface }}.conf
      register: ip_check
      failed_when: false
      changed_when: false

    - name: ArrÃªter si l'IP est dÃ©jÃ  utilisÃ©e
      fail:
        msg: "âŒ L'IP {{ user_ip }} est dÃ©jÃ  utilisÃ©e par un autre utilisateur. Choisissez une autre IP."
      when: ip_check.rc == 0

    - name: VÃ©rifier que le nom d'utilisateur est valide
      assert:
        that:
          - username | length > 0
          - username | regex_search('^[a-zA-Z0-9_-]+$')
        fail_msg: "Le nom d'utilisateur doit contenir uniquement des lettres, chiffres, tirets et underscores"
        success_msg: "Nom d'utilisateur valide"

    - name: VÃ©rifier que l'utilisateur n'existe pas dÃ©jÃ 
      stat:
        path: "{{ wireguard_clients_path }}/{{ username }}.conf"
      register: user_exists

    - name: ArrÃªter si l'utilisateur existe dÃ©jÃ 
      fail:
        msg: "âŒ L'utilisateur '{{ username }}' existe dÃ©jÃ . Choisissez un autre nom."
      when: user_exists.stat.exists

  roles:
    - role: adduser
      tags: adduser

  post_tasks:
    - name: Afficher un rÃ©sumÃ© de la crÃ©ation
      debug:
        msg:
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "âœ… Utilisateur VPN crÃ©Ã© avec succÃ¨s !"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ‘¤ Nom d'utilisateur : {{ username }}"
          - "ğŸŒ IP VPN attribuÃ©e  : {{ user_ip }}"
          - ""
          - "ğŸ“ Fichiers crÃ©Ã©s :"
          - "   â€¢ Configuration : {{ wireguard_clients_path }}/{{ username }}.conf"
          - "   â€¢ QR Code       : {{ wireguard_qr_path }}/{{ username }}.png"
          - ""
          - "ğŸ“± Pour utiliser le VPN :"
          - "   1. TÃ©lÃ©chargez le fichier .conf ou scannez le QR code"
          - "   2. Importez-le dans votre client WireGuard"
          - "   3. Activez la connexion VPN"
          - ""
          - "ğŸ”— AccÃ¨s aux fichiers :"
          - "   â€¢ WebUI : http://{{ ansible_default_ipv4.address }}:{{ webui_port }}"
          - ""
          - "ğŸŒ Service interne (accessible uniquement via VPN) :"
          - "   â€¢ Nginx : http://{{ wireguard_server_ip }}:{{ nginx_port }}"
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
